<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CondoKanban - Board Seguro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {sans: ['Inter', 'sans-serif']},
                    colors: {
                        brand: {
                            bg: '#F5F5F4', card: '#FFFFFF', text: '#292524', subtext: '#57534E',
                            accent: '#D97706', secondary: '#0EA5E9', success: '#10B981', warning: '#F59E0B', danger: '#EF4444'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }

        .kanban-col {
            min-width: 280px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .kanban-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .kanban-card:active {
            transform: scale(0.98);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 40;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        #filterFab {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        #filterFab:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.35);
        }

        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }

        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        @keyframes pulse-badge {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .badge-pulse {
            animation: pulse-badge 2s infinite;
        }

        /* MARCA D'ÃGUA DE SEGURANÃ‡A */
        .security-layer {
            pointer-events: none !important;
            user-select: none !important;
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999 !important;
            mix-blend-mode: multiply;
            opacity: 0.02 !important;
            /* Quase invisÃ­vel na tela */
            transition: opacity 0.3s;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Aumenta opacidade para aparecer na impressÃ£o */
            .security-layer {
                opacity: 0.1 !important;
                display: block !important;
                visibility: visible !important;
            }

            /* Esconde elementos de UI na impressÃ£o */
            header,
            .fab,
            button {
                display: none !important;
            }
        }

        /* LimitaÃ§Ã£o de selects de categoria em telas pequenas */
        @media (max-width: 640px) {

            #newCategory,
            #modalCategorySelect {
                max-width: 100%;
                width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            #newCategory option,
            #modalCategorySelect option {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }
    </style>
</head>

<body class="bg-brand-bg text-brand-text h-[100dvh] overflow-hidden flex flex-col relative">

    <header class="bg-white border-b border-stone-200 z-30 shadow-sm flex-none relative">
        <div class="max-w-full mx-auto px-4">
            <div class="h-[64px] flex items-center justify-between">
                <div class="flex items-center gap-2 w-auto cursor-pointer z-20"
                    onclick="window.location.href='index.html'">
                    <div
                        class="w-8 h-8 bg-brand-accent rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-sm">
                        C</div>
                    <span class="font-bold text-lg tracking-tight block">CondoKanban</span>
                </div>

                <button onclick="app.toggleMobileMenu()"
                    class="md:hidden p-2 text-stone-500 hover:text-brand-accent focus:outline-none z-20">
                    <i id="mobileMenuIcon" class="fas fa-bars text-xl transition-transform duration-300"></i>
                </button>

                <div id="navbarContent"
                    class="hidden md:flex md:flex-1 md:items-center md:justify-between md:w-auto md:ml-4 transition-all duration-300 ease-in-out overflow-hidden md:overflow-visible opacity-0 max-h-0 md:opacity-100 md:max-h-full absolute md:relative top-[64px] md:top-0 left-0 right-0 bg-white md:bg-transparent border-t md:border-t-0 border-stone-100 px-4 md:px-0 pb-4 md:pb-0">

                    <div
                        class="flex flex-col md:flex-row flex-wrap items-start md:items-center justify-center gap-3 md:gap-4 w-full md:w-auto mt-4 md:mt-0 mb-4 md:mb-0 md:mx-auto">

                        <!-- Linha 1: Dropdown de usuÃ¡rios (mobile) -->
                        <div class="w-full md:w-auto flex items-center justify-center">
                            <div
                                class="w-full md:w-auto flex items-center gap-2 bg-stone-100 p-1 rounded-lg border border-stone-200 shadow-inner">
                                <i class="fas fa-user-circle text-stone-400 ml-2"></i>
                                <select id="simulatedUser"
                                    class="bg-transparent text-sm font-semibold text-brand-text border-none focus:ring-0 cursor-pointer outline-none w-full md:w-auto"
                                    onchange="app.switchUser(this.value)">
                                    <option value="manager">Grupo Gestor - GG</option>
                                    <option value="resident_A_2">Morador (Bl A - 2Âº Andar)</option>
                                    <option value="resident_B_5">Morador (Bl B - 5Âº Andar)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Linha 2: BotÃµes do menu (mobile) -->
                        <div class="w-full md:w-auto flex items-center justify-center gap-2 md:hidden">
                            <button onclick="app.openArchiveListModal()"
                                class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition relative group"
                                title="Arquivo">
                                <i class="fas fa-archive"></i>
                            </button>

                            <button onclick="app.openLogModal()"
                                class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition relative group"
                                title="HistÃ³rico">
                                <i class="fas fa-history"></i>
                            </button>

                            <button id="pendingCallsMobile" onclick="app.openPendingCallsModal()"
                                class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition relative group hidden"
                                title="Meus Chamados Pendentes">
                                <i class="fas fa-hourglass-half"></i>
                                <span id="pendingBadgeMobile"
                                    class="hidden absolute -top-1 -right-1 bg-orange-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white badge-pulse">0</span>
                            </button>

                            <div id="managerMenuMobile" class="hidden flex gap-2 items-center">
                                <button onclick="app.openTriageModal()"
                                    class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition relative group"
                                    title="Triagem">
                                    <i class="fas fa-tasks"></i>
                                    <span id="triageBadgeMobile"
                                        class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white badge-pulse">0</span>
                                </button>

                                <button onclick="app.openUserModal()"
                                    class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition"
                                    title="UsuÃ¡rios">
                                    <i class="fas fa-users"></i>
                                </button>

                                <button onclick="app.downloadLog()"
                                    class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition"
                                    title="Baixar Log">
                                    <i class="fas fa-file-csv"></i>
                                </button>
                            </div>

                            <button onclick="window.location.href='index.html'"
                                class="p-2 text-stone-500 hover:text-brand-danger hover:bg-stone-50 rounded-full transition"
                                title="Sair">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div
                        class="flex items-center justify-end gap-2 w-full md:w-auto border-t md:border-t-0 border-stone-100 pt-3 md:pt-0 hidden md:flex">
                        <button onclick="app.openArchiveListModal()"
                            class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition relative group"
                            title="Arquivo">
                            <i class="fas fa-archive"></i>
                        </button>

                        <button onclick="app.openLogModal()"
                            class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition relative group"
                            title="HistÃ³rico">
                            <i class="fas fa-history"></i>
                        </button>

                        <button id="pendingCallsDesktop" onclick="app.openPendingCallsModal()"
                            class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition relative group hidden"
                            title="Meus Chamados Pendentes">
                            <i class="fas fa-hourglass-half"></i>
                            <span id="pendingBadgeDesktop"
                                class="hidden absolute -top-1 -right-1 bg-orange-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white badge-pulse">0</span>
                        </button>

                        <div id="managerMenu" class="hidden flex gap-2 items-center">
                            <button onclick="app.openTriageModal()"
                                class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition relative group"
                                title="Triagem">
                                <i class="fas fa-tasks"></i>
                                <span id="triageBadge"
                                    class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white badge-pulse">0</span>
                            </button>

                            <div class="h-4 w-px bg-stone-300 mx-1 hidden md:block"></div>

                            <button onclick="app.openUserModal()"
                                class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition"
                                title="UsuÃ¡rios">
                                <i class="fas fa-users"></i>
                            </button>
                            <button onclick="app.downloadLog()"
                                class="p-2 text-stone-500 hover:text-brand-accent hover:bg-stone-50 rounded-full transition"
                                title="Baixar Log">
                                <i class="fas fa-file-csv"></i>
                            </button>
                        </div>

                        <div class="h-6 w-px bg-stone-200 mx-1 hidden md:block"></div>

                        <button onclick="window.location.href='index.html'"
                            class="text-sm font-semibold text-stone-500 hover:text-brand-danger transition px-2 flex items-center gap-2">
                            <i class="fas fa-sign-out-alt"></i> <span class="hidden sm:inline">Sair</span>
                        </button>
                    </div>
                </div>
            </div>
    </header>

    <main class="flex-1 overflow-x-auto overflow-y-hidden bg-brand-bg p-4" id="mainBoard">
        <div class="flex gap-4 h-full items-start min-w-max mx-auto" style="max-width: fit-content;">
            <div class="kanban-col w-72 md:w-80 bg-stone-100/50 rounded-xl border border-stone-200">
                <div
                    class="p-3 border-b border-stone-200/50 flex justify-between items-center bg-stone-100 rounded-t-xl sticky top-0 flex-none">
                    <h3 class="font-bold text-stone-600 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-stone-400"></div> A Fazer
                    </h3>
                    <span
                        class="bg-white text-stone-600 px-2 py-0.5 rounded text-xs font-bold border border-stone-200 shadow-sm"
                        id="count-backlog">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-2 pb-20" id="col-backlog"></div>
            </div>
            <div class="kanban-col w-72 md:w-80 bg-blue-50/50 rounded-xl border border-blue-100">
                <div
                    class="p-3 border-b border-blue-100 flex justify-between items-center bg-blue-50 rounded-t-xl sticky top-0 flex-none">
                    <h3 class="font-bold text-blue-700 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div> Fazendo
                    </h3>
                    <span
                        class="bg-white text-blue-600 px-2 py-0.5 rounded text-xs font-bold border border-blue-100 shadow-sm"
                        id="count-doing">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-2 pb-20" id="col-doing"></div>
            </div>
            <div class="kanban-col w-72 md:w-80 bg-red-50/50 rounded-xl border border-red-100">
                <div
                    class="p-3 border-b border-red-100 flex justify-between items-center bg-red-50 rounded-t-xl sticky top-0 flex-none">
                    <h3 class="font-bold text-red-700 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-red-500"></div> Enroscado
                    </h3>
                    <span
                        class="bg-white text-red-600 px-2 py-0.5 rounded text-xs font-bold border border-red-100 shadow-sm"
                        id="count-stuck">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-2 pb-20" id="col-stuck"></div>
            </div>
            <div class="kanban-col w-72 md:w-80 bg-green-50/50 rounded-xl border border-green-100">
                <div
                    class="p-3 border-b border-green-100 flex justify-between items-center bg-green-50 rounded-t-xl sticky top-0 flex-none">
                    <h3 class="font-bold text-green-700 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div> Feito
                    </h3>
                    <span
                        class="bg-white text-green-600 px-2 py-0.5 rounded text-xs font-bold border border-green-100 shadow-sm"
                        id="count-done">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-2 pb-20" id="col-done"></div>
            </div>
        </div>
    </main>

    <button id="filterFab" onclick="app.openFilterModal()"
        class="fixed bottom-[96px] right-6 z-40 w-14 h-14 bg-blue-500 hover:bg-blue-600 text-white rounded-full flex items-center justify-center text-xl transition-transform hover:scale-110 active:scale-95 shadow-lg hidden"
        title="Filtros de VisualizaÃ§Ã£o">
        <i class="fas fa-eye"></i>
    </button>

    <button id="newTicketFab" onclick="app.openNewTicketModal()"
        class="fab w-14 h-14 bg-brand-accent hover:bg-amber-600 text-white rounded-full flex items-center justify-center text-2xl transition-transform hover:scale-110 active:scale-95 hidden">
        <i class="fas fa-plus"></i>
    </button>

    <div id="archiveListModal"
        class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-[95%] md:w-full max-w-5xl mx-auto rounded-xl shadow-2xl flex flex-col max-h-[90vh] transform scale-95 transition-transform duration-300">
            <div
                class="p-6 border-b border-stone-200 flex justify-between items-center bg-stone-50 rounded-t-xl relative">
                <div class="absolute left-0 right-0 text-center pointer-events-none">
                    <h2 class="text-xl font-bold text-brand-text flex items-center justify-center gap-2">
                        <i class="fas fa-archive text-stone-400"></i> Arquivo Morto
                    </h2>
                </div>
                <div></div>
                <button onclick="app.closeTopModal()"
                    class="text-stone-400 hover:text-red-500 text-2xl z-10">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-0">
                <table class="w-full text-left text-sm">
                    <thead class="bg-stone-50 border-b border-stone-200 text-stone-500 sticky top-0 shadow-sm">
                        <tr>
                            <th class="px-6 py-4 font-semibold">TÃ­tulo</th>
                            <th class="px-6 py-4 font-semibold">Data</th>
                            <th class="px-6 py-4 font-semibold">Quem Abriu</th>
                            <th class="px-6 py-4 font-semibold text-right">AÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-stone-100" id="archiveTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="logModal"
        class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-[95%] md:w-full max-w-4xl mx-auto rounded-xl shadow-2xl flex flex-col max-h-[90vh] transform scale-95 transition-transform duration-300">
            <div class="p-6 border-b border-stone-200 flex justify-between items-center bg-stone-50 rounded-t-xl">
                <div>
                    <h2 class="text-xl font-bold text-brand-text flex items-center gap-2">
                        <i class="fas fa-list-alt text-brand-accent"></i> Registro de Atividades
                    </h2>
                    <p id="logSubtitle" class="text-xs text-stone-500 mt-1">Visualizando todas as movimentaÃ§Ãµes</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="app.downloadLog()"
                        class="text-xs flex items-center gap-1 bg-stone-100 hover:bg-stone-200 text-stone-600 px-3 py-1.5 rounded-lg transition mr-4"
                        title="Baixar VisualizaÃ§Ã£o Atual">
                        <i class="fas fa-download"></i> Baixar CSV
                    </button>
                    <button onclick="app.closeTopModal()"
                        class="text-stone-400 hover:text-red-500 text-2xl">&times;</button>
                </div>
            </div>
            <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-2 text-sm text-stone-600">
                    <span>Exibir</span>
                    <select id="logPageSize"
                        onchange="app.logState.pageSize = parseInt(this.value); app.logState.page = 1; app.renderLogs();"
                        class="border border-stone-300 rounded p-1 text-sm bg-white focus:ring-1 focus:ring-brand-accent outline-none">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>por pÃ¡gina</span>
                </div>
                <div class="text-xs font-bold text-stone-400 uppercase tracking-wider" id="logTotalCount"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-0">
                <table class="w-full text-left text-sm border-collapse">
                    <thead class="bg-stone-50 text-stone-500 sticky top-0 shadow-sm">
                        <tr>
                            <th class="px-6 py-3 font-semibold w-32">Data</th>
                            <th class="px-6 py-3 font-semibold w-48">Contexto</th>
                            <th class="px-6 py-3 font-semibold w-32">UsuÃ¡rio</th>
                            <th class="px-6 py-3 font-semibold w-40">AÃ§Ã£o</th>
                            <th class="px-6 py-3 font-semibold">Detalhes</th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody" class="divide-y divide-stone-100"></tbody>
                </table>
            </div>
            <div class="p-4 border-t border-stone-200 bg-stone-50 rounded-b-xl flex justify-between items-center">
                <button onclick="app.changeLogPage(-1)" id="btnPrevLog"
                    class="px-4 py-2 bg-white border border-stone-300 rounded-lg text-sm text-stone-600 hover:bg-stone-100 disabled:opacity-50">Anterior</button>
                <span id="logPageInfo" class="text-sm font-medium text-stone-600">PÃ¡gina 1</span>
                <button onclick="app.changeLogPage(1)" id="btnNextLog"
                    class="px-4 py-2 bg-white border border-stone-300 rounded-lg text-sm text-stone-600 hover:bg-stone-100 disabled:opacity-50">PrÃ³ximo</button>
            </div>
        </div>
    </div>

    <div id="cardModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-full max-w-2xl mx-4 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] transform scale-95 transition-transform duration-300 border border-stone-200">
            <div class="p-6 pb-4 border-b border-stone-200 bg-white z-10 shrink-0">
                <div class="flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <h2 id="modalTitle" class="text-xl font-bold text-brand-text leading-tight"></h2>
                    </div>
                    <button onclick="app.closeTopModal()"
                        class="h-8 w-8 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-400 hover:text-stone-600 text-2xl leading-none transition flex-shrink-0">&times;</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-6 py-4 bg-stone-50/30">
                <!-- Badges e metadados -->
                <div class="flex items-center gap-2 flex-wrap mb-4">
                    <span id="modalPriority"
                        class="h-8 inline-flex items-center justify-center text-xs font-bold px-3 rounded border">Q?</span>
                    <span id="modalCategory"
                        class="h-8 inline-flex items-center gap-1.5 text-xs font-bold px-3 rounded border"></span>
                    <div id="modalCategoryEdit" class="hidden">
                        <select id="modalCategorySelect" onchange="app.updateTaskCategory()"
                            class="h-8 max-w-full text-xs font-medium px-2 rounded border border-stone-300 bg-white focus:ring-2 focus:ring-brand-accent outline-none overflow-hidden">
                            <optgroup label="âš¡ ElÃ©trica">
                                <option value="eletrica_geral">âš¡ ElÃ©trica (Geral/Outros)</option>
                                <option value="lampada_queimada">ğŸ’¡ LÃ¢mpada Queimada (Ãrea Comum)</option>
                                <option value="disjuntor_caindo">ğŸ“‰ Disjuntor Caindo / Queda de Energia</option>
                                <option value="tomada_defeito">ğŸ”Œ Tomada / Interruptor com Defeito</option>
                                <option value="sensor_presenca">ğŸš¶ Sensor de PresenÃ§a Falhando</option>
                                <option value="interfone_mudo">ğŸ“ Interfone Mudo / Chiando</option>
                                <option value="portao_motor">âš™ï¸ Motor do PortÃ£o Travado</option>
                                <option value="cerca_eletrica">âš¡ Cerca ElÃ©trica (Estalando/Rompida)</option>
                                <option value="para_raios">ğŸŒ©ï¸ Para-raios / Aterramento</option>
                                <option value="gerador">ğŸ”‹ Gerador (Falha/CombustÃ­vel)</option>
                                <option value="timer_minuteria">â±ï¸ Timer / Minuteria Travada</option>
                                <option value="luz_emergencia">ğŸ”¦ Luz de EmergÃªncia Queimada</option>
                            </optgroup>
                            <optgroup label="ğŸ’§ HidrÃ¡ulica e GÃ¡s">
                                <option value="hidraulica_geral">ğŸ’§ HidrÃ¡ulica (Geral/Outros)</option>
                                <option value="vazamento_agua">ğŸ’¦ Vazamento de Ãgua VisÃ­vel</option>
                                <option value="infiltracao_parede">ğŸŒ«ï¸ InfiltraÃ§Ã£o / Umidade em Parede</option>
                                <option value="torneira_pingando">ğŸš° Torneira Pingando / Quebrada</option>
                                <option value="chuveiro_comum">ğŸš¿ Chuveiro (VestiÃ¡rio/Piscina)</option>
                                <option value="vaso_entupido">ğŸš½ Vaso SanitÃ¡rio Entupido</option>
                                <option value="ralo_entupido">ğŸ› Ralo / Calha Entupida</option>
                                <option value="pressao_agua">ğŸ“‰ PressÃ£o da Ãgua (Baixa/Alta)</option>
                                <option value="bomba_dagua">âš™ï¸ Bomba d'Ã¡gua (Barulho/Defeito)</option>
                                <option value="falta_agua">ğŸš± Falta de Ãgua</option>
                                <option value="cheiro_gas">â›½ Cheiro de GÃ¡s / TubulaÃ§Ã£o</option>
                                <option value="hidrante">ğŸš’ Hidrante / Mangueira Danificada</option>
                            </optgroup>
                            <optgroup label="ğŸ—ï¸ Estrutura e Predial">
                                <option value="estrutura_geral">ğŸ—ï¸ Estrutura (Geral/Outros)</option>
                                <option value="piso_quebrado">ğŸ§± Piso Quebrado / Solto</option>
                                <option value="vidro_quebrado">ğŸªŸ Vidro Quebrado / Trincado</option>
                                <option value="porta_fechadura">ğŸšª Porta / MaÃ§aneta / Mola</option>
                                <option value="janela_basculante">ğŸªŸ Janela / Basculante Emperrado</option>
                                <option value="telhado_telha">ğŸ  Telhado / Telha Solta</option>
                                <option value="calhas_rufos">ğŸŒ§ï¸ Calhas e Rufos</option>
                                <option value="fachada_pastilha">ğŸ¢ Fachada / Pastilha Caindo</option>
                                <option value="pintura_descascando">ğŸ¨ Pintura Descascando / Suja</option>
                                <option value="muro_cerca">ğŸ§± Muro / Grade Danificada</option>
                                <option value="acessibilidade">â™¿ Rampa / Acessibilidade</option>
                                <option value="escada_corrimao">ğŸªœ Escada / CorrimÃ£o Solto</option>
                            </optgroup>
                            <optgroup label="ğŸ›¡ï¸ SeguranÃ§a">
                                <option value="seguranca_geral">ğŸ›¡ï¸ SeguranÃ§a (Geral/Outros)</option>
                                <option value="camera_cftv">ğŸ“¹ CÃ¢mera sem Imagem / CFTV</option>
                                <option value="alarme_disparado">ğŸš¨ Alarme Disparando</option>
                                <option value="controle_acesso">ğŸ†” Tag / Biometria / Facial Falhando</option>
                                <option value="chaves_controles">ğŸ”‘ Chaves e Controles Remotos</option>
                                <option value="extintor_vencido">ğŸ§¯ Extintor Vencido/Vazio</option>
                                <option value="acesso_estranho">ğŸ•µï¸ PresenÃ§a de Estranhos</option>
                                <option value="veiculo_suspeito">ğŸš™ VeÃ­culo Suspeito</option>
                                <option value="furto_roubo">ğŸ’° Furto ou Roubo</option>
                            </optgroup>
                            <optgroup label="ğŸ§¹ Limpeza e ConservaÃ§Ã£o">
                                <option value="limpeza_geral">ğŸ§¹ Limpeza (Geral/Outros)</option>
                                <option value="coleta_lixo">ğŸ—‘ï¸ Lixo Acumulado / NÃ£o Coletado</option>
                                <option value="mau_cheiro">ğŸ¤¢ Mau Cheiro</option>
                                <option value="pragas">ğŸ¦— Pragas (Baratas, Ratos, Formigas)</option>
                                <option value="limpeza_elevador">ğŸ›— Limpeza do Elevador</option>
                                <option value="limpeza_escadas">ğŸªœ Limpeza de Escadas/Corredores</option>
                                <option value="limpeza_hall">âœ¨ Limpeza do Hall de Entrada</option>
                                <option value="oleo_garagem">âš« Mancha de Ã“leo na Garagem</option>
                                <option value="limpeza_vidros">ğŸªŸ Vidros Sujos</option>
                            </optgroup>
                            <optgroup label="ğŸŒ¿ Jardinagem">
                                <option value="jardinagem_geral">ğŸŒ¿ Jardinagem (Geral/Outros)</option>
                                <option value="grama_alta">âœ‚ï¸ Grama Alta</option>
                                <option value="poda_arvore">ğŸŒ³ Poda de Ãrvore / Galho Perigoso</option>
                                <option value="plantas_mortas">ğŸ¥€ Plantas Secas / Mortas</option>
                                <option value="irrigacao">ğŸš¿ Sistema de IrrigaÃ§Ã£o</option>
                                <option value="vasos_jardineiras">ğŸº Vasos e Jardineiras</option>
                                <option value="folhas_sujeira">ğŸ‚ Excesso de Folhas Secas</option>
                            </optgroup>
                            <optgroup label="ğŸ›— Elevadores">
                                <option value="elevador_geral">ğŸ›— Elevador (Geral/Outros)</option>
                                <option value="elevador_parado">ğŸ›‘ Elevador Parado / Travado</option>
                                <option value="elevador_barulho">ğŸ”Š Barulho Anormal no Elevador</option>
                                <option value="elevador_luz">ğŸ’¡ Luz Interna do Elevador</option>
                                <option value="elevador_botoes">ğŸ”¢ BotÃµes do Painel Falhando</option>
                                <option value="elevador_porta">ğŸšª Porta nÃ£o abre/fecha</option>
                                <option value="elevador_ventilador">ğŸ’¨ Ventilador/Exaustor do Elevador</option>
                            </optgroup>
                            <optgroup label="âš½ Ãreas de Lazer">
                                <option value="lazer_geral">âš½ Ãreas de Lazer (Geral/Outros)</option>
                                <option value="piscina_agua">ğŸŠ Piscina (Ãgua Suja/Turva)</option>
                                <option value="piscina_fisica">ğŸ§© Piscina (Azulejo/Borda/Escada)</option>
                                <option value="academia_equipamento">ğŸ‹ï¸ Academia (Equipamento Quebrado)
                                </option>
                                <option value="salao_festas">ğŸ‰ SalÃ£o de Festas (Limpeza/Danos)</option>
                                <option value="churrasqueira">ğŸ– Churrasqueira (Grelha/Exaustor)</option>
                                <option value="playground">ğŸ› Playground / Brinquedo Quebrado</option>
                                <option value="quadra_esportiva">ğŸ¥… Quadra (Rede/Piso/IluminaÃ§Ã£o)</option>
                                <option value="sauna">ğŸ§– Sauna (NÃ£o Esquenta)</option>
                                <option value="salao_jogos">ğŸ± SalÃ£o de Jogos (Sinuca/Mesa)</option>
                            </optgroup>
                            <optgroup label="ğŸ”‡ ConvivÃªncia e Regras">
                                <option value="convivencia_geral">ğŸ”‡ ConvivÃªncia (Geral/Outros)</option>
                                <option value="barulho_som">ğŸ”Š Barulho Excessivo (Som/Gritos)</option>
                                <option value="barulho_obra">ğŸ”¨ Barulho de Obra (Fora de HorÃ¡rio)</option>
                                <option value="barulho_passos">ğŸ‘  Barulho de Passos/MÃ³veis</option>
                                <option value="animais_barulho">ğŸ¶ Animais (Latidos/Barulho)</option>
                                <option value="animais_sujeira">ğŸ’© Animais (Dejetos/Sem Guia)</option>
                                <option value="cigarro">ğŸš¬ Cigarro em Ãrea Proibida</option>
                                <option value="objeto_corredor">ğŸš² Objeto em Corredor/Ãrea Comum</option>
                                <option value="uso_indevido">ğŸš« Uso Indevido de Ãrea Comum</option>
                            </optgroup>
                            <optgroup label="ğŸš— Garagem e VeÃ­culos">
                                <option value="garagem_geral">ğŸš— Garagem (Geral/Outros)</option>
                                <option value="vaga_indevida">ğŸš« Carro na Vaga Errada</option>
                                <option value="vaga_ocupacao">ğŸ“ Carro Ocupando 2 Vagas</option>
                                <option value="bicicletario">ğŸš² BicicletÃ¡rio (Lotado/Desorganizado)</option>
                                <option value="carro_abandonado">ğŸ•¸ï¸ VeÃ­culo Abandonado</option>
                                <option value="batida_veiculo">ğŸ’¥ ColisÃ£o / Dano em VeÃ­culo</option>
                                <option value="portao_garagem_uso">ğŸš§ Uso Indevido do PortÃ£o</option>
                            </optgroup>
                            <optgroup label="ğŸ“¦ Portaria e Encomendas">
                                <option value="portaria_geral">ğŸ“¦ Portaria (Geral/Outros)</option>
                                <option value="encomenda_sumida">â“ Encomenda NÃ£o Localizada</option>
                                <option value="delivery_problema">ğŸ• Problema com Delivery</option>
                                <option value="correspondencia">ğŸ“¬ CorrespondÃªncia Trocada</option>
                                <option value="atendimento_staff">ğŸ¤ Atendimento / Postura do FuncionÃ¡rio
                                </option>
                            </optgroup>
                            <optgroup label="ğŸ“‚ Administrativo">
                                <option value="admin_geral">ğŸ“‚ Administrativo (Geral/Outros)</option>
                                <option value="segunda_via_boleto">ğŸ“„ 2Âª Via de Boleto / Cota</option>
                                <option value="atualizacao_cadastral">ğŸ“ AtualizaÃ§Ã£o de Cadastro</option>
                                <option value="reserva_espaco">ğŸ“… Reserva de EspaÃ§o</option>
                                <option value="agendamento_mudanca">ğŸš› Agendamento de MudanÃ§a</option>
                                <option value="multa_recurso">âš ï¸ Recurso de Multa</option>
                                <option value="assembleia_ata">ğŸ“‹ DÃºvida sobre Assembleia/Ata</option>
                            </optgroup>
                            <optgroup label="â“ Diversos">
                                <option value="sugestao">ğŸ’¡ SugestÃ£o de Melhoria</option>
                                <option value="elogio">ğŸ‘ Elogio</option>
                                <option value="outros">â“ Outros Assuntos</option>
                            </optgroup>
                        </select>
                    </div>
                    <div id="modalVisibilityContainer" class="h-8 flex items-center"></div>
                </div>

                <!-- TÃ­tulos originais/gerenciais -->
                <div id="originalTitleContainer" class="hidden mb-3">
                    <div class="bg-red-50 border border-red-100 p-2 pb-3 rounded-lg relative">
                        <span
                            class="absolute top-0 right-0 bg-red-100 text-red-600 text-[9px] font-bold px-1.5 py-0.5 rounded-tr-lg rounded-bl-lg border-b border-l border-red-200">
                            <i class="fas fa-lock"></i> TÃTULO ORIGINAL (PRIVADO)
                        </span>
                        <h2 id="modalOriginalTitle" class="text-lg font-bold text-stone-800 leading-tight pt-4"></h2>
                    </div>
                </div>

                <div id="managerTitleEditor" class="hidden mb-3">
                    <label class="block text-xs font-bold text-brand-secondary uppercase mb-1">
                        <i class="fas fa-shield-alt"></i> TÃ­tulo PÃºblico (Mediado)
                    </label>
                    <input type="text" id="publicTitleInput"
                        class="w-full border-2 border-brand-secondary/30 rounded-lg p-2 text-sm focus:ring-2 focus:ring-brand-secondary focus:border-brand-secondary outline-none transition"
                        placeholder="VersÃ£o mediada do tÃ­tulo (ex: 'ReclamaÃ§Ã£o de vizinhanÃ§a')...">
                    <div class="flex justify-end gap-2 mt-1">
                        <button id="approveOriginalTitleBtn" onclick="app.approveOriginalTitle()"
                            class="text-xs bg-green-600 text-white px-3 py-1 rounded font-bold hover:bg-green-700 transition">
                            <i class="fas fa-check"></i> Aprovar TÃ­tulo Original
                        </button>
                        <button onclick="app.savePublicTitle()"
                            class="text-xs bg-brand-secondary text-white px-3 py-1 rounded font-bold hover:bg-sky-600 transition">
                            Salvar TÃ­tulo PÃºblico
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-3 rounded-lg border border-stone-200 shadow-sm">
                        <p class="text-xs font-bold text-stone-400 uppercase mb-1">Status Atual</p>
                        <span id="modalStatus" class="font-bold text-sm uppercase text-brand-accent"></span>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-stone-200 shadow-sm">
                        <p class="text-xs font-bold text-stone-400 uppercase mb-1">Detalhes</p>
                        <div class="text-xs space-y-1">
                            <div class="flex justify-between" id="modalOwnerRow">
                                <span class="text-stone-500">Solicitante:</span> <span id="modalOwner"
                                    class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-stone-500">Criado em:</span> <span id="modalDate"
                                    class="font-medium"></span>
                            </div>
                            <div id="modalFollowersContainer" class="hidden border-t border-stone-100 pt-1 mt-1">
                                <span class="block text-stone-500 mb-0.5">Seguidores:</span>
                                <span id="modalFollowersList"
                                    class="font-medium text-stone-700 block leading-tight"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="modalStuckReasonContainer"
                    class="hidden mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                    <h4 class="text-red-700 font-bold text-sm mb-1 flex items-center gap-2"><i
                            class="fas fa-exclamation-circle"></i> Motivo do Enrosco</h4>
                    <p id="modalStuckReason" class="text-sm text-red-600 italic"></p>
                </div>

                <div class="mb-6">
                    <h5
                        class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-2 flex justify-between items-center">
                        <span>DescriÃ§Ã£o</span>
                        <span id="privacyIndicator" class="text-[10px] px-2 py-0.5 rounded border hidden"></span>
                    </h5>

                    <div id="originalDescContainer" class="hidden mb-3">
                        <div class="bg-red-50 border border-red-100 p-3 pb-4 rounded-lg relative">
                            <span
                                class="absolute top-0 right-0 bg-red-100 text-red-600 text-[9px] font-bold px-1.5 py-0.5 rounded-tr-lg rounded-bl-lg border-b border-l border-red-200">
                                <i class="fas fa-lock"></i> ORIGINAL (PRIVADO)
                            </span>
                            <p id="modalOriginalDesc" class="text-sm text-stone-700 leading-relaxed pt-2"></p>
                        </div>
                    </div>

                    <div id="publicSummaryContainer">
                        <div class="relative">
                            <p id="modalPublicSummary"
                                class="text-sm text-stone-700 leading-relaxed bg-white p-4 rounded-lg border border-stone-200 hidden">
                            </p>
                            <span id="publicViewLabel"
                                class="hidden absolute top-0 right-0 bg-stone-100 text-stone-500 text-[9px] font-bold px-1.5 py-0.5 rounded-bl-lg border-b border-l border-stone-200">
                                <i class="fas fa-eye"></i> VISÃƒO PÃšBLICA
                            </span>
                        </div>

                        <div id="managerSummaryEditor" class="hidden mt-2">
                            <label class="block text-xs font-bold text-brand-secondary uppercase mb-1">
                                <i class="fas fa-edit"></i> Editar Resumo PÃºblico (Sanitizado)
                            </label>
                            <textarea id="summaryInput"
                                class="w-full border-2 border-brand-secondary/30 rounded-lg p-3 text-sm focus:ring-2 focus:ring-brand-secondary focus:border-brand-secondary outline-none transition"
                                rows="3"
                                placeholder="Escreva aqui uma versÃ£o segura para exibiÃ§Ã£o pÃºblica (ex: 'ReclamaÃ§Ã£o de ruÃ­do noturno')..."></textarea>
                            <div class="flex justify-end gap-2 mt-1">
                                <button id="approveOriginalBtn" onclick="app.approveOriginalDescription()"
                                    class="text-xs bg-green-600 text-white px-3 py-1 rounded font-bold hover:bg-green-700 transition">
                                    <i class="fas fa-check"></i> Aprovar DescriÃ§Ã£o Original
                                </button>
                                <button onclick="app.savePublicSummary()"
                                    class="text-xs bg-brand-secondary text-white px-3 py-1 rounded font-bold hover:bg-sky-600 transition">
                                    Salvar Resumo PÃºblico
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="modalAttachments" class="mb-6">
                    <h5 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Anexos</h5>
                    <div id="attachmentsList" class="flex gap-2 overflow-x-auto pb-2 no-scrollbar"></div>
                </div>

                <!-- SeÃ§Ã£o de ComentÃ¡rios -->
                <div class="mb-6">
                    <h5 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">ComentÃ¡rios</h5>
                    <div class="flex gap-2" id="commentsSection">
                        <input type="text" id="newCommentInput"
                            class="flex-1 border border-stone-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-accent focus:border-transparent outline-none transition"
                            placeholder="Adicionar comentÃ¡rio...">
                        <button onclick="app.addComment()"
                            class="bg-stone-100 text-stone-600 px-4 py-2 rounded-lg hover:bg-stone-200 font-bold text-sm transition"><i
                                class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <div class="pt-4 border-t border-stone-200">
                    <h5 class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="fas fa-history"></i> HistÃ³rico de Atividades
                    </h5>
                    <div id="auditTrail" class="space-y-4">
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-stone-200 bg-white shrink-0 z-10">
                <div id="triageReasonContainer" class="hidden mb-3">
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1">ObservaÃ§Ã£o da Triagem (Opcional
                        p/ Backlog)</label>
                    <textarea id="triageReasonInput"
                        class="w-full border border-stone-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-brand-accent outline-none"
                        rows="2" placeholder="Motivo da aprovaÃ§Ã£o ou arquivamento..."></textarea>
                </div>
                <div id="modalActions" class="space-y-2">
                    <div class="border-t border-stone-200 pt-3">
                        <h3 class="text-xs font-bold text-stone-500 uppercase tracking-wider mb-2">Mover para</h3>
                        <div id="actionButtonsGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-2"></div>
                    </div>
                    <button id="archiveActionBtn" onclick="app.archiveCurrentTask()"
                        class="w-full mt-2 p-2 text-stone-400 hover:text-red-500 text-xs font-semibold flex items-center justify-center gap-2 transition">
                        <i class="fas fa-archive"></i> Arquivar este chamado
                    </button>
                </div>
                <div id="modalReadOnlyMsg" class="hidden text-center text-xs text-stone-400 italic py-2">
                    Somente leitura de status. ComentÃ¡rios permitidos.
                </div>
            </div>
        </div>
    </div>

    <div id="triageModal"
        class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-[95%] md:w-full max-w-3xl mx-auto rounded-xl shadow-2xl flex flex-col max-h-[80vh] transform scale-95 transition-transform duration-300">
            <div class="p-6 border-b border-stone-200 flex justify-between items-center bg-stone-50 rounded-t-xl">
                <div>
                    <h2 class="text-xl font-bold text-brand-text flex items-center gap-2">
                        <i class="fas fa-tasks text-brand-accent"></i> Triagem de Chamados
                    </h2>
                    <p class="text-xs text-stone-500 mt-1">Chamados abertos aguardando classificaÃ§Ã£o e aprovaÃ§Ã£o.</p>
                </div>
                <button onclick="app.closeTopModal()"
                    class="text-stone-400 hover:text-stone-600 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-0 rounded-b-xl">
                <table class="w-full text-left text-sm">
                    <thead class="bg-stone-50 text-stone-500 sticky top-0 shadow-sm">
                        <tr>
                            <th class="px-6 py-3 font-semibold">Data</th>
                            <th class="px-6 py-3 font-semibold">TÃ­tulo</th>
                            <th class="px-6 py-3 font-semibold">Categoria</th>
                            <th class="px-6 py-3 font-semibold">Prioridade (IA)</th>
                            <th class="px-6 py-3 font-semibold text-right">AÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody id="triageTableBody"
                        class="divide-y divide-stone-100 [&>tr:last-child]:rounded-b-xl [&>tr:last-child>td:first-child]:rounded-bl-xl [&>tr:last-child>td:last-child]:rounded-br-xl">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="archiveConfirmModal"
        class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-full max-w-sm mx-4 rounded-xl p-6 shadow-xl transform scale-95 transition-transform duration-300">
            <h3 class="font-bold text-lg mb-2 text-stone-700">Arquivar Chamado?</h3>
            <p class="text-sm text-stone-500 mb-4">O chamado serÃ¡ movido para o Arquivo Morto.</p>
            <textarea id="archiveReasonInput"
                class="w-full border border-stone-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-stone-500 focus:border-stone-500 outline-none mb-4 hidden"
                rows="2" placeholder="Motivo do arquivamento (ObrigatÃ³rio)..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="app.closeTopModal()"
                    class="px-4 py-2 text-stone-500 font-semibold hover:bg-stone-100 rounded">Cancelar</button>
                <button onclick="app.confirmArchive()"
                    class="px-4 py-2 bg-stone-600 text-white font-semibold rounded hover:bg-stone-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="stuckModal"
        class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-full max-w-sm mx-4 rounded-xl p-6 shadow-xl transform scale-95 transition-transform duration-300">
            <h3 class="font-bold text-lg mb-2 text-red-600">Por que estÃ¡ enroscado?</h3>
            <textarea id="stuckReasonInput"
                class="w-full border border-stone-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none mb-4"
                rows="3" placeholder="Ex: Aguardando peÃ§a, falta de verba..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="app.closeTopModal()"
                    class="px-4 py-2 text-stone-500 font-semibold hover:bg-stone-100 rounded">Cancelar</button>
                <button onclick="app.confirmStuck()"
                    class="px-4 py-2 bg-red-600 text-white font-semibold rounded hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="userModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-full max-w-2xl mx-4 rounded-xl shadow-2xl flex flex-col max-h-[90vh] transform scale-95 transition-transform duration-300">
            <div class="p-6 border-b border-stone-200 flex justify-between items-center">
                <h2 class="text-xl font-bold">GestÃ£o de CondÃ´minos</h2>
                <button onclick="app.closeTopModal()" class="text-stone-400 hover:text-stone-600"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="p-6 bg-stone-50 border-b border-stone-200">
                <h4 class="text-xs font-bold uppercase text-stone-500 mb-2">Adicionar Novo</h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                    <input type="text" id="uName" placeholder="Nome Completo"
                        class="text-sm p-2 rounded border border-stone-300">
                    <input type="email" id="uEmail" placeholder="E-mail"
                        class="text-sm p-2 rounded border border-stone-300">
                    <input type="text" id="uUnit" placeholder="Unid (Bl A - 202)"
                        class="text-sm p-2 rounded border border-stone-300">
                    <button onclick="app.addUser()"
                        class="bg-brand-success text-white rounded text-sm font-bold hover:bg-emerald-600 h-10">Adicionar</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="text-stone-500 border-b">
                            <th class="pb-2">Nome</th>
                            <th class="pb-2">Unidade</th>
                            <th class="pb-2">Email</th>
                            <th class="pb-2 text-right">AÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="newTicketModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-full max-w-md mx-4 rounded-xl p-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4">Novo Chamado</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1">O que estÃ¡ acontecendo?</label>
                    <input type="text" id="newTitle"
                        class="w-full border border-stone-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-brand-accent outline-none"
                        placeholder="Ex: Luz do corredor queimada">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Detalhes (Original -
                        Privado)</label>
                    <textarea id="newDesc"
                        class="w-full border border-stone-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-brand-accent outline-none"
                        rows="3" placeholder="Descreva melhor o problema..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Categoria</label>
                    <select id="newCategory"
                        class="w-full max-w-full border border-stone-300 rounded-lg p-2.5 text-sm bg-white overflow-hidden">
                        <option value="" disabled selected>Selecione a categoria do chamado...</option>

                        <optgroup label="âš¡ ElÃ©trica">
                            <option value="eletrica_geral">âš¡ ElÃ©trica (Geral/Outros)</option>
                            <option value="lampada_queimada">ğŸ’¡ LÃ¢mpada Queimada (Ãrea Comum)</option>
                            <option value="disjuntor_caindo">ğŸ“‰ Disjuntor Caindo / Queda de Energia</option>
                            <option value="tomada_defeito">ğŸ”Œ Tomada / Interruptor com Defeito</option>
                            <option value="sensor_presenca">ğŸš¶ Sensor de PresenÃ§a Falhando</option>
                            <option value="interfone_mudo">ğŸ“ Interfone Mudo / Chiando</option>
                            <option value="portao_motor">âš™ï¸ Motor do PortÃ£o Travado</option>
                            <option value="cerca_eletrica">âš¡ Cerca ElÃ©trica (Estalando/Rompida)</option>
                            <option value="para_raios">ğŸŒ©ï¸ Para-raios / Aterramento</option>
                            <option value="gerador">ğŸ”‹ Gerador (Falha/CombustÃ­vel)</option>
                            <option value="timer_minuteria">â±ï¸ Timer / Minuteria Travada</option>
                            <option value="luz_emergencia">ğŸ”¦ Luz de EmergÃªncia Queimada</option>
                        </optgroup>

                        <optgroup label="ğŸ’§ HidrÃ¡ulica e GÃ¡s">
                            <option value="hidraulica_geral">ğŸ’§ HidrÃ¡ulica (Geral/Outros)</option>
                            <option value="vazamento_agua">ğŸ’¦ Vazamento de Ãgua VisÃ­vel</option>
                            <option value="infiltracao_parede">ğŸŒ«ï¸ InfiltraÃ§Ã£o / Umidade em Parede</option>
                            <option value="torneira_pingando">ğŸš° Torneira Pingando / Quebrada</option>
                            <option value="chuveiro_comum">ğŸš¿ Chuveiro (VestiÃ¡rio/Piscina)</option>
                            <option value="vaso_entupido">ğŸš½ Vaso SanitÃ¡rio Entupido</option>
                            <option value="ralo_entupido">ğŸ› Ralo / Calha Entupida</option>
                            <option value="pressao_agua">ğŸ“‰ PressÃ£o da Ãgua (Baixa/Alta)</option>
                            <option value="bomba_dagua">âš™ï¸ Bomba d'Ã¡gua (Barulho/Defeito)</option>
                            <option value="falta_agua">ğŸš± Falta de Ãgua</option>
                            <option value="cheiro_gas">â›½ Cheiro de GÃ¡s / TubulaÃ§Ã£o</option>
                            <option value="hidrante">ğŸš’ Hidrante / Mangueira Danificada</option>
                        </optgroup>

                        <optgroup label="ğŸ—ï¸ Estrutura e Predial">
                            <option value="estrutura_geral">ğŸ—ï¸ Estrutura (Geral/Outros)</option>
                            <option value="piso_quebrado">ğŸ§± Piso Quebrado / Solto</option>
                            <option value="vidro_quebrado">ğŸªŸ Vidro Quebrado / Trincado</option>
                            <option value="porta_fechadura">ğŸšª Porta / MaÃ§aneta / Mola</option>
                            <option value="janela_basculante">ğŸªŸ Janela / Basculante Emperrado</option>
                            <option value="telhado_telha">ğŸ  Telhado / Telha Solta</option>
                            <option value="calhas_rufos">ğŸŒ§ï¸ Calhas e Rufos</option>
                            <option value="fachada_pastilha">ğŸ¢ Fachada / Pastilha Caindo</option>
                            <option value="pintura_descascando">ğŸ¨ Pintura Descascando / Suja</option>
                            <option value="muro_cerca">ğŸ§± Muro / Grade Danificada</option>
                            <option value="acessibilidade">â™¿ Rampa / Acessibilidade</option>
                            <option value="escada_corrimao">ğŸªœ Escada / CorrimÃ£o Solto</option>
                        </optgroup>

                        <optgroup label="ğŸ›¡ï¸ SeguranÃ§a">
                            <option value="seguranca_geral">ğŸ›¡ï¸ SeguranÃ§a (Geral/Outros)</option>
                            <option value="camera_cftv">ğŸ“¹ CÃ¢mera sem Imagem / CFTV</option>
                            <option value="alarme_disparado">ğŸš¨ Alarme Disparando</option>
                            <option value="controle_acesso">ğŸ†” Tag / Biometria / Facial Falhando</option>
                            <option value="chaves_controles">ğŸ”‘ Chaves e Controles Remotos</option>
                            <option value="extintor_vencido">ğŸ§¯ Extintor Vencido/Vazio</option>
                            <option value="acesso_estranho">ğŸ•µï¸ PresenÃ§a de Estranhos</option>
                            <option value="veiculo_suspeito">ğŸš™ VeÃ­culo Suspeito</option>
                            <option value="furto_roubo">ğŸ’° Furto ou Roubo</option>
                        </optgroup>

                        <optgroup label="ğŸ§¹ Limpeza e ConservaÃ§Ã£o">
                            <option value="limpeza_geral">ğŸ§¹ Limpeza (Geral/Outros)</option>
                            <option value="coleta_lixo">ğŸ—‘ï¸ Lixo Acumulado / NÃ£o Coletado</option>
                            <option value="mau_cheiro">ğŸ¤¢ Mau Cheiro</option>
                            <option value="pragas">ğŸ¦— Pragas (Baratas, Ratos, Formigas)</option>
                            <option value="limpeza_elevador">ğŸ›— Limpeza do Elevador</option>
                            <option value="limpeza_escadas">ğŸªœ Limpeza de Escadas/Corredores</option>
                            <option value="limpeza_hall">âœ¨ Limpeza do Hall de Entrada</option>
                            <option value="oleo_garagem">âš« Mancha de Ã“leo na Garagem</option>
                            <option value="limpeza_vidros">ğŸªŸ Vidros Sujos</option>
                        </optgroup>

                        <optgroup label="ğŸŒ¿ Jardinagem">
                            <option value="jardinagem_geral">ğŸŒ¿ Jardinagem (Geral/Outros)</option>
                            <option value="grama_alta">âœ‚ï¸ Grama Alta</option>
                            <option value="poda_arvore">ğŸŒ³ Poda de Ãrvore / Galho Perigoso</option>
                            <option value="plantas_mortas">ğŸ¥€ Plantas Secas / Mortas</option>
                            <option value="irrigacao">ğŸš¿ Sistema de IrrigaÃ§Ã£o</option>
                            <option value="vasos_jardineiras">ğŸº Vasos e Jardineiras</option>
                            <option value="folhas_sujeira">ğŸ‚ Excesso de Folhas Secas</option>
                        </optgroup>

                        <optgroup label="ğŸ›— Elevadores">
                            <option value="elevador_geral">ğŸ›— Elevador (Geral/Outros)</option>
                            <option value="elevador_parado">ğŸ›‘ Elevador Parado / Travado</option>
                            <option value="elevador_barulho">ğŸ”Š Barulho Anormal no Elevador</option>
                            <option value="elevador_luz">ğŸ’¡ Luz Interna do Elevador</option>
                            <option value="elevador_botoes">ğŸ”¢ BotÃµes do Painel Falhando</option>
                            <option value="elevador_porta">ğŸšª Porta nÃ£o abre/fecha</option>
                            <option value="elevador_ventilador">ğŸ’¨ Ventilador/Exaustor do Elevador</option>
                        </optgroup>

                        <optgroup label="âš½ Ãreas de Lazer">
                            <option value="lazer_geral">âš½ Ãreas de Lazer (Geral/Outros)</option>
                            <option value="piscina_agua">ğŸŠ Piscina (Ãgua Suja/Turva)</option>
                            <option value="piscina_fisica">ğŸ§© Piscina (Azulejo/Borda/Escada)</option>
                            <option value="academia_equipamento">ğŸ‹ï¸ Academia (Equipamento Quebrado)</option>
                            <option value="salao_festas">ğŸ‰ SalÃ£o de Festas (Limpeza/Danos)</option>
                            <option value="churrasqueira">ğŸ– Churrasqueira (Grelha/Exaustor)</option>
                            <option value="playground">ğŸ› Playground / Brinquedo Quebrado</option>
                            <option value="quadra_esportiva">ğŸ¥… Quadra (Rede/Piso/IluminaÃ§Ã£o)</option>
                            <option value="sauna">ğŸ§– Sauna (NÃ£o Esquenta)</option>
                            <option value="salao_jogos">ğŸ± SalÃ£o de Jogos (Sinuca/Mesa)</option>
                        </optgroup>

                        <optgroup label="ğŸ”‡ ConvivÃªncia e Regras">
                            <option value="convivencia_geral">ğŸ”‡ ConvivÃªncia (Geral/Outros)</option>
                            <option value="barulho_som">ğŸ”Š Barulho Excessivo (Som/Gritos)</option>
                            <option value="barulho_obra">ğŸ”¨ Barulho de Obra (Fora de HorÃ¡rio)</option>
                            <option value="barulho_passos">ğŸ‘  Barulho de Passos/MÃ³veis</option>
                            <option value="animais_barulho">ğŸ¶ Animais (Latidos/Barulho)</option>
                            <option value="animais_sujeira">ğŸ’© Animais (Dejetos/Sem Guia)</option>
                            <option value="cigarro">ğŸš¬ Cigarro em Ãrea Proibida</option>
                            <option value="objeto_corredor">ğŸš² Objeto em Corredor/Ãrea Comum</option>
                            <option value="uso_indevido">ğŸš« Uso Indevido de Ãrea Comum</option>
                        </optgroup>

                        <optgroup label="ğŸš— Garagem e VeÃ­culos">
                            <option value="garagem_geral">ğŸš— Garagem (Geral/Outros)</option>
                            <option value="vaga_indevida">ğŸš« Carro na Vaga Errada</option>
                            <option value="vaga_ocupacao">ğŸ“ Carro Ocupando 2 Vagas</option>
                            <option value="bicicletario">ğŸš² BicicletÃ¡rio (Lotado/Desorganizado)</option>
                            <option value="carro_abandonado">ğŸ•¸ï¸ VeÃ­culo Abandonado</option>
                            <option value="batida_veiculo">ğŸ’¥ ColisÃ£o / Dano em VeÃ­culo</option>
                            <option value="portao_garagem_uso">ğŸš§ Uso Indevido do PortÃ£o</option>
                        </optgroup>

                        <optgroup label="ğŸ“¦ Portaria e Encomendas">
                            <option value="portaria_geral">ğŸ“¦ Portaria (Geral/Outros)</option>
                            <option value="encomenda_sumida">â“ Encomenda NÃ£o Localizada</option>
                            <option value="delivery_problema">ğŸ• Problema com Delivery</option>
                            <option value="correspondencia">ğŸ“¬ CorrespondÃªncia Trocada</option>
                            <option value="atendimento_staff">ğŸ¤ Atendimento / Postura do FuncionÃ¡rio</option>
                        </optgroup>

                        <optgroup label="ğŸ“‚ Administrativo">
                            <option value="admin_geral">ğŸ“‚ Administrativo (Geral/Outros)</option>
                            <option value="segunda_via_boleto">ğŸ“„ 2Âª Via de Boleto / Cota</option>
                            <option value="atualizacao_cadastral">ğŸ“ AtualizaÃ§Ã£o de Cadastro</option>
                            <option value="reserva_espaco">ğŸ“… Reserva de EspaÃ§o</option>
                            <option value="agendamento_mudanca">ğŸš› Agendamento de MudanÃ§a</option>
                            <option value="multa_recurso">âš ï¸ Recurso de Multa</option>
                            <option value="assembleia_ata">ğŸ“‹ DÃºvida sobre Assembleia/Ata</option>
                        </optgroup>

                        <optgroup label="â“ Diversos">
                            <option value="sugestao">ğŸ’¡ SugestÃ£o de Melhoria</option>
                            <option value="elogio">ğŸ‘ Elogio</option>
                            <option value="outros">â“ Outros Assuntos</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Visibilidade</label>
                    <select id="newVisibility" class="w-full border border-stone-300 rounded-lg p-2.5 text-sm bg-white">
                        <option value="public">PÃºblico (Todos veem)</option>
                        <option value="block">Meu Bloco</option>
                        <option value="floor">Meu Andar</option>
                        <option value="private">Privado (SÃ³ eu e o SÃ­ndico)</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="app.closeTopModal()"
                    class="px-4 py-2 text-stone-500 font-semibold hover:bg-stone-100 rounded">Cancelar</button>
                <button onclick="app.createNewTicket()"
                    class="px-4 py-2 bg-brand-accent text-white font-semibold rounded hover:bg-amber-700">Abrir
                    Chamado</button>
            </div>
        </div>
    </div>

    <div id="filterModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-full max-w-md mx-4 rounded-xl p-6 shadow-2xl transform scale-95 transition-transform duration-300">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-eye text-blue-500"></i> Filtros de VisualizaÃ§Ã£o
            </h2>
            <p class="text-sm text-stone-500 mb-4">Escolha quais tipos de chamados vocÃª deseja visualizar:</p>
            <div class="space-y-3">
                <button onclick="app.toggleFilter('private')" id="btn-filter-private-modal"
                    class="w-full px-4 py-3 text-sm font-bold rounded-lg border border-stone-300 text-stone-700 bg-stone-50 hover:bg-stone-100 transition-all flex items-center justify-between">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-user-lock text-base"></i>
                        <span>Meus Chamados</span>
                    </span>
                    <span id="badge-private-modal"
                        class="bg-stone-600 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </button>

                <button onclick="app.toggleFilter('following')" id="btn-filter-following-modal"
                    class="w-full px-4 py-3 text-sm font-bold rounded-lg border border-amber-200 text-amber-700 bg-amber-50 hover:bg-amber-100 transition-all flex items-center justify-between">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-star text-base"></i>
                        <span>Seguindo</span>
                    </span>
                    <span id="badge-following-modal"
                        class="bg-amber-600 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </button>

                <button onclick="app.toggleFilter('floor')" id="btn-filter-floor-modal"
                    class="w-full px-4 py-3 text-sm font-bold rounded-lg border border-purple-200 text-purple-700 bg-purple-50 hover:bg-purple-100 transition-all flex items-center justify-between">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-layer-group text-base"></i>
                        <span>Meu Andar</span>
                    </span>
                    <span id="badge-floor-modal"
                        class="bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </button>

                <button onclick="app.toggleFilter('block')" id="btn-filter-block-modal"
                    class="w-full px-4 py-3 text-sm font-bold rounded-lg border border-blue-200 text-blue-700 bg-blue-50 hover:bg-blue-100 transition-all flex items-center justify-between">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-building text-base"></i>
                        <span>Meu Bloco</span>
                    </span>
                    <span id="badge-block-modal"
                        class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </button>

                <button onclick="app.toggleFilter('public')" id="btn-filter-public-modal"
                    class="w-full px-4 py-3 text-sm font-bold rounded-lg border border-green-200 text-green-700 bg-green-50 hover:bg-green-100 transition-all flex items-center justify-between">
                    <span class="flex items-center gap-2">
                        <i class="fas fa-globe text-base"></i>
                        <span>PÃºblico</span>
                    </span>
                    <span id="badge-public-modal"
                        class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </button>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="app.closeTopModal()"
                    class="px-4 py-2 text-stone-500 font-semibold hover:bg-stone-100 rounded">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Chamados Pendentes (Morador) -->
    <div id="pendingCallsModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-full max-w-4xl mx-4 rounded-xl p-6 shadow-2xl transform scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-hourglass-half text-orange-500"></i> Meus Chamados Pendentes
            </h2>
            <p class="text-sm text-stone-500 mb-4">Chamados criados por vocÃª aguardando classificaÃ§Ã£o e aprovaÃ§Ã£o do
                Gestor:</p>

            <div id="pendingCallsTable" class="overflow-x-auto">
                <!-- ConteÃºdo serÃ¡ preenchido dinamicamente -->
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button onclick="app.closeTopModal()"
                    class="px-4 py-2 text-stone-500 font-semibold hover:bg-stone-100 rounded">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Filtros do Gestor -->
    <div id="managerFilterModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div
            class="bg-white w-full max-w-2xl mx-4 rounded-xl p-6 shadow-2xl transform scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="fas fa-filter text-blue-500"></i> Filtros de VisualizaÃ§Ã£o (Gestor)
            </h2>
            <p class="text-sm text-stone-500 mb-4">Escolha como deseja visualizar e organizar os chamados:</p>

            <!-- SeÃ§Ã£o: Por Categoria -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-stone-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-tags text-brand-accent"></i> Por Categoria
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                    <button onclick="app.toggleManagerFilter('category', 'eletrica')" id="btn-mgr-cat-eletrica"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>âš¡ ElÃ©trica</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'hidraulica')" id="btn-mgr-cat-hidraulica"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ’§ HidrÃ¡ulica</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'estrutura')" id="btn-mgr-cat-estrutura"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ—ï¸ Estrutura</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'seguranca')" id="btn-mgr-cat-seguranca"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ›¡ï¸ SeguranÃ§a</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'limpeza')" id="btn-mgr-cat-limpeza"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ§¹ Limpeza</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'jardinagem')" id="btn-mgr-cat-jardinagem"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸŒ¿ Jardinagem</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'elevadores')" id="btn-mgr-cat-elevadores"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ›— Elevadores</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'areas_lazer')" id="btn-mgr-cat-areas_lazer"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸŠâ€â™‚ï¸ Ãreas de Lazer</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'convivencia_regras')"
                        id="btn-mgr-cat-convivencia_regras"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ‘¥ ConvivÃªncia e Regras</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'garagem_veiculos')"
                        id="btn-mgr-cat-garagem_veiculos"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸš— Garagem e VeÃ­culos</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'portaria_encomendas')"
                        id="btn-mgr-cat-portaria_encomendas"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ“¦ Portaria e Encomendas</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'administrativo')"
                        id="btn-mgr-cat-administrativo"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ“‚ Administrativo</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('category', 'outros')" id="btn-mgr-cat-outros"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>â“ Outros</span>
                    </button>
                </div>
            </div>

            <!-- SeÃ§Ã£o: Por LocalizaÃ§Ã£o - Blocos -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-stone-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-building text-blue-600"></i> Por Bloco
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="app.toggleManagerFilter('block', 'all')" id="btn-mgr-block-all"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>Todos Blocos</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('block', 'A')" id="btn-mgr-block-A"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>Bloco A</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('block', 'B')" id="btn-mgr-block-B"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>Bloco B</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('block', 'C')" id="btn-mgr-block-C"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>Bloco C</span>
                    </button>
                </div>
            </div>

            <!-- SeÃ§Ã£o: Por LocalizaÃ§Ã£o - Andares -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-stone-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-layer-group text-purple-600"></i> Por Andar
                </h3>
                <div class="grid grid-cols-3 md:grid-cols-5 gap-2">
                    <button onclick="app.toggleManagerFilter('floor', 'all')" id="btn-mgr-floor-all"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>Todos</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '1')" id="btn-mgr-floor-1"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>1Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '2')" id="btn-mgr-floor-2"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>2Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '3')" id="btn-mgr-floor-3"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>3Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '4')" id="btn-mgr-floor-4"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>4Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '5')" id="btn-mgr-floor-5"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>5Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '6')" id="btn-mgr-floor-6"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>6Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '7')" id="btn-mgr-floor-7"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>7Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '8')" id="btn-mgr-floor-8"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>8Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '9')" id="btn-mgr-floor-9"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>9Âº</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('floor', '10')" id="btn-mgr-floor-10"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>10Âº</span>
                    </button>
                </div>
            </div>

            <!-- SeÃ§Ã£o: Por Visibilidade -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-stone-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-eye text-green-600"></i> Por Visibilidade
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="app.toggleManagerFilter('visibility', 'public')" id="btn-mgr-vis-public"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸŒ PÃºblico</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('visibility', 'block')" id="btn-mgr-vis-block"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ¢ Bloco</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('visibility', 'floor')" id="btn-mgr-vis-floor"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ“Š Andar</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('visibility', 'private')" id="btn-mgr-vis-private"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>ğŸ”’ Privado</span>
                    </button>
                </div>
            </div>

            <!-- SeÃ§Ã£o: Por Status de Resumo PÃºblico -->
            <div class="mb-6">
                <h3 class="text-sm font-bold text-stone-700 mb-3 flex items-center gap-2">
                    <i class="fas fa-file-alt text-orange-600"></i> Por Status de Resumo
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <button onclick="app.toggleManagerFilter('pendingSummary', 'true')" id="btn-mgr-pending-true"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>âš ï¸ Pendentes de Resumo</span>
                    </button>
                    <button onclick="app.toggleManagerFilter('pendingSummary', 'false')" id="btn-mgr-pending-false"
                        class="px-3 py-2 text-xs font-bold rounded-lg border transition-all">
                        <span>âœ… Com Resumo Definido</span>
                    </button>
                </div>
            </div>

            <div class="flex justify-between gap-2 mt-6">
                <button onclick="app.clearManagerFilters()"
                    class="px-4 py-2 text-red-600 font-semibold hover:bg-red-50 rounded border border-red-200">
                    Limpar Filtros
                </button>
                <button onclick="app.closeTopModal()"
                    class="px-4 py-2 text-stone-500 font-semibold hover:bg-stone-100 rounded">Fechar</button>
            </div>
        </div>
    </div>

    <div id="toast-container"
        class="fixed top-4 right-4 z-[100] flex flex-col gap-3 pointer-events-none p-4 w-full max-w-sm"></div>

    <script>
        // ========================================
        // CONSTANTES E CONFIGURAÃ‡Ã•ES
        // ========================================
        const CONFIG = {
            PRIORITY_COLORS: {
                'Q1': 'border-l-red-500',
                'Q2': 'border-l-blue-500',
                'Q3': 'border-l-yellow-500',
                'Q4': 'border-l-stone-300'
            },
            PRIORITY_TEXT_COLORS: {
                'Q1': 'text-red-600',
                'Q2': 'text-blue-600',
                'Q3': 'text-yellow-600',
                'Q4': 'text-stone-500'
            },
            PRIORITY_BADGE_STYLES: {
                'Q1': {text: 'text-red-700', bg: 'bg-red-100', border: 'border-red-200'},
                'Q2': {text: 'text-blue-700', bg: 'bg-blue-100', border: 'border-blue-200'},
                'Q3': {text: 'text-yellow-700', bg: 'bg-yellow-100', border: 'border-yellow-200'},
                'Q4': {text: 'text-stone-600', bg: 'bg-stone-100', border: 'border-stone-200'}
            },
            VISIBILITY_BADGES: {
                'public': '<span class="text-[10px] leading-none uppercase font-bold text-green-600 bg-green-100 px-1.5 rounded border border-green-200 h-6 inline-flex items-center justify-center">PÃºblico</span>',
                'block': '<span class="text-[10px] leading-none uppercase font-bold text-blue-600 bg-blue-100 px-1.5 rounded border border-blue-200 h-6 inline-flex items-center justify-center">Bloco</span>',
                'floor': '<span class="text-[10px] leading-none uppercase font-bold text-purple-600 bg-purple-100 px-1.5 rounded border border-purple-200 h-6 inline-flex items-center justify-center">Andar</span>',
                'private': '<span class="text-[10px] leading-none uppercase font-bold text-stone-500 bg-stone-200 px-1.5 rounded border border-stone-300 h-6 inline-flex items-center justify-center">Privado</span>'
            },
            VISIBILITY_LABELS: {
                public: 'PÃºblico',
                block: 'Bloco',
                floor: 'Andar',
                private: 'Privado'
            },
            VISIBILITY_MODAL_STYLES: {
                'public': 'bg-green-100 text-green-600 border-green-200',
                'block': 'bg-blue-100 text-blue-600 border-blue-200',
                'floor': 'bg-purple-100 text-purple-600 border-purple-200',
                'private': 'bg-stone-200 text-stone-600 border-stone-300'
            },
            FILTER_CONFIGS: {
                'private': {
                    activeClass: 'bg-stone-200 border-stone-400 text-stone-900 ring-2 ring-stone-300',
                    inactiveClass: 'bg-stone-50 border-stone-300 text-stone-700 hover:bg-stone-100',
                    badgeColor: 'bg-stone-600'
                },
                'following': {
                    activeClass: 'bg-amber-200 border-amber-400 text-amber-900 ring-2 ring-amber-300',
                    inactiveClass: 'bg-amber-50 border-amber-200 text-amber-700 hover:bg-amber-100',
                    badgeColor: 'bg-amber-600'
                },
                'floor': {
                    activeClass: 'bg-purple-200 border-purple-400 text-purple-900 ring-2 ring-purple-300',
                    inactiveClass: 'bg-purple-50 border-purple-200 text-purple-700 hover:bg-purple-100',
                    badgeColor: 'bg-purple-600'
                },
                'block': {
                    activeClass: 'bg-blue-200 border-blue-400 text-blue-900 ring-2 ring-blue-300',
                    inactiveClass: 'bg-blue-50 border-blue-200 text-blue-700 hover:bg-blue-100',
                    badgeColor: 'bg-blue-600'
                },
                'public': {
                    activeClass: 'bg-green-200 border-green-400 text-green-900 ring-2 ring-green-300',
                    inactiveClass: 'bg-green-50 border-green-200 text-green-700 hover:bg-green-100',
                    badgeColor: 'bg-green-600'
                }
            },
            STATUS_STYLES: {
                'backlog': {label: 'Backlog', class: 'border-stone-200 hover:bg-stone-50 text-stone-600'},
                'doing': {label: 'Fazendo', class: 'border-blue-200 bg-blue-50 text-blue-700 hover:bg-blue-100'},
                'stuck': {label: 'Enroscado', class: 'border-red-200 bg-red-50 text-red-700 hover:bg-red-100'},
                'done': {label: 'Feito', class: 'border-green-200 bg-green-50 text-green-700 hover:bg-green-100'}
            },
            TOAST_CONFIG: {
                success: {border: 'border-l-green-500', icon: '<i class="fas fa-check-circle text-green-500 text-xl"></i>', bar: 'bg-green-500'},
                warning: {border: 'border-l-amber-500', icon: '<i class="fas fa-exclamation-triangle text-amber-500 text-xl"></i>', bar: 'bg-amber-500'},
                info: {border: 'border-l-blue-500', icon: '<i class="fas fa-info-circle text-blue-500 text-xl"></i>', bar: 'bg-blue-500'}
            },
            USER_BLOCKS: {
                'resident_A_2': {block: 'A', floor: '2', name: 'JoÃ£o Silva', unit: 'Bl A - 202'},
                'resident_B_5': {block: 'B', floor: '5', name: 'Maria Souza', unit: 'Bl B - 501'}
            },
            CATEGORIES: {
                'eletrica': {
                    label: 'ElÃ©trica',
                    icon: 'fas fa-bolt',
                    emoji: 'âš¡',
                    color: 'text-yellow-600',
                    bgColor: 'bg-yellow-50',
                    borderColor: 'border-yellow-300',
                    badgeBg: 'bg-yellow-100',
                    badgeText: 'text-yellow-700',
                    badgeBorder: 'border-yellow-200'
                },
                'hidraulica': {
                    label: 'HidrÃ¡ulica',
                    icon: 'fas fa-droplet',
                    emoji: 'ğŸ’§',
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    borderColor: 'border-blue-300',
                    badgeBg: 'bg-blue-100',
                    badgeText: 'text-blue-700',
                    badgeBorder: 'border-blue-200'
                },
                'estrutura': {
                    label: 'Estrutura',
                    icon: 'fas fa-hammer',
                    emoji: 'ğŸ—ï¸',
                    color: 'text-orange-600',
                    bgColor: 'bg-orange-50',
                    borderColor: 'border-orange-300',
                    badgeBg: 'bg-orange-100',
                    badgeText: 'text-orange-700',
                    badgeBorder: 'border-orange-200'
                },
                'seguranca': {
                    label: 'SeguranÃ§a',
                    icon: 'fas fa-shield-alt',
                    emoji: 'ğŸ›¡ï¸',
                    color: 'text-red-600',
                    bgColor: 'bg-red-50',
                    borderColor: 'border-red-300',
                    badgeBg: 'bg-red-100',
                    badgeText: 'text-red-700',
                    badgeBorder: 'border-red-200'
                },
                'limpeza': {
                    label: 'Limpeza',
                    icon: 'fas fa-broom',
                    emoji: 'ğŸ§¹',
                    color: 'text-emerald-600',
                    bgColor: 'bg-emerald-50',
                    borderColor: 'border-emerald-300',
                    badgeBg: 'bg-emerald-100',
                    badgeText: 'text-emerald-700',
                    badgeBorder: 'border-emerald-200'
                },
                'jardinagem': {
                    label: 'Jardinagem',
                    icon: 'fas fa-leaf',
                    emoji: 'ğŸŒ¿',
                    color: 'text-green-600',
                    bgColor: 'bg-green-50',
                    borderColor: 'border-green-300',
                    badgeBg: 'bg-green-100',
                    badgeText: 'text-green-700',
                    badgeBorder: 'border-green-200'
                },
                'elevadores': {
                    label: 'Elevadores',
                    icon: 'fas fa-elevator',
                    emoji: 'ğŸ›—',
                    color: 'text-sky-600',
                    bgColor: 'bg-sky-50',
                    borderColor: 'border-sky-300',
                    badgeBg: 'bg-sky-100',
                    badgeText: 'text-sky-700',
                    badgeBorder: 'border-sky-200'
                },
                'areas_lazer': {
                    label: 'Ãreas de Lazer',
                    icon: 'fas fa-swimming-pool',
                    emoji: 'ğŸŠâ€â™‚ï¸',
                    color: 'text-purple-600',
                    bgColor: 'bg-purple-50',
                    borderColor: 'border-purple-300',
                    badgeBg: 'bg-purple-100',
                    badgeText: 'text-purple-700',
                    badgeBorder: 'border-purple-200'
                },
                'convivencia_regras': {
                    label: 'ConvivÃªncia e Regras',
                    icon: 'fas fa-users',
                    emoji: 'ğŸ‘¥',
                    color: 'text-pink-600',
                    bgColor: 'bg-pink-50',
                    borderColor: 'border-pink-300',
                    badgeBg: 'bg-pink-100',
                    badgeText: 'text-pink-700',
                    badgeBorder: 'border-pink-200'
                },
                'garagem_veiculos': {
                    label: 'Garagem e VeÃ­culos',
                    icon: 'fas fa-car',
                    emoji: 'ğŸš—',
                    color: 'text-indigo-600',
                    bgColor: 'bg-indigo-50',
                    borderColor: 'border-indigo-300',
                    badgeBg: 'bg-indigo-100',
                    badgeText: 'text-indigo-700',
                    badgeBorder: 'border-indigo-200'
                },
                'portaria_encomendas': {
                    label: 'Portaria e Encomendas',
                    icon: 'fas fa-box-open',
                    emoji: 'ğŸ“¦',
                    color: 'text-amber-600',
                    bgColor: 'bg-amber-50',
                    borderColor: 'border-amber-300',
                    badgeBg: 'bg-amber-100',
                    badgeText: 'text-amber-700',
                    badgeBorder: 'border-amber-200'
                },
                'administrativo': {
                    label: 'Administrativo',
                    icon: 'fas fa-file-invoice-dollar',
                    emoji: 'ğŸ“‚',
                    color: 'text-cyan-600',
                    bgColor: 'bg-cyan-50',
                    borderColor: 'border-cyan-300',
                    badgeBg: 'bg-cyan-100',
                    badgeText: 'text-cyan-700',
                    badgeBorder: 'border-cyan-200'
                },
                'outros': {
                    label: 'Outros',
                    icon: 'fas fa-circle-question',
                    emoji: 'â“',
                    color: 'text-stone-600',
                    bgColor: 'bg-stone-50',
                    borderColor: 'border-stone-300',
                    badgeBg: 'bg-stone-100',
                    badgeText: 'text-stone-700',
                    badgeBorder: 'border-stone-200'
                }
            },
            // Mapeamento de categorias detalhadas para categorias principais
            CATEGORY_MAPPING: {
                // ElÃ©trica
                'eletrica_geral': 'eletrica',
                'lampada_queimada': 'eletrica',
                'disjuntor_caindo': 'eletrica',
                'tomada_defeito': 'eletrica',
                'sensor_presenca': 'eletrica',
                'interfone_mudo': 'eletrica',
                'portao_motor': 'eletrica',
                'cerca_eletrica': 'eletrica',
                'para_raios': 'eletrica',
                'gerador': 'eletrica',
                'timer_minuteria': 'eletrica',
                'luz_emergencia': 'eletrica',
                // HidrÃ¡ulica
                'hidraulica_geral': 'hidraulica',
                'vazamento_agua': 'hidraulica',
                'infiltracao_parede': 'hidraulica',
                'torneira_pingando': 'hidraulica',
                'chuveiro_comum': 'hidraulica',
                'vaso_entupido': 'hidraulica',
                'ralo_entupido': 'hidraulica',
                'pressao_agua': 'hidraulica',
                'bomba_dagua': 'hidraulica',
                'falta_agua': 'hidraulica',
                'cheiro_gas': 'hidraulica',
                'hidrante': 'hidraulica',
                // Estrutura
                'estrutura_geral': 'estrutura',
                'piso_quebrado': 'estrutura',
                'vidro_quebrado': 'estrutura',
                'porta_fechadura': 'estrutura',
                'janela_basculante': 'estrutura',
                'telhado_telha': 'estrutura',
                'calhas_rufos': 'estrutura',
                'fachada_pastilha': 'estrutura',
                'pintura_descascando': 'estrutura',
                'muro_cerca': 'estrutura',
                'acessibilidade': 'estrutura',
                'escada_corrimao': 'estrutura',
                // SeguranÃ§a
                'seguranca_geral': 'seguranca',
                'camera_cftv': 'seguranca',
                'alarme_disparado': 'seguranca',
                'controle_acesso': 'seguranca',
                'chaves_controles': 'seguranca',
                'extintor_vencido': 'seguranca',
                'acesso_estranho': 'seguranca',
                'veiculo_suspeito': 'seguranca',
                'furto_roubo': 'seguranca',
                // Limpeza
                'limpeza_geral': 'limpeza',
                'coleta_lixo': 'limpeza',
                'mau_cheiro': 'limpeza',
                'pragas': 'limpeza',
                'limpeza_elevador': 'limpeza',
                'limpeza_escadas': 'limpeza',
                'limpeza_hall': 'limpeza',
                'oleo_garagem': 'limpeza',
                'limpeza_vidros': 'limpeza',
                // Jardinagem
                'jardinagem_geral': 'jardinagem',
                'grama_alta': 'jardinagem',
                'poda_arvore': 'jardinagem',
                'plantas_mortas': 'jardinagem',
                'irrigacao': 'jardinagem',
                'vasos_jardineiras': 'jardinagem',
                'folhas_sujeira': 'jardinagem',
                // Elevadores
                'elevador_geral': 'elevadores',
                'elevador_parado': 'elevadores',
                'elevador_barulho': 'elevadores',
                'elevador_luz': 'elevadores',
                'elevador_botoes': 'elevadores',
                'elevador_porta': 'elevadores',
                'elevador_ventilador': 'elevadores',
                // Ãreas de Lazer
                'lazer_geral': 'areas_lazer',
                'piscina_agua': 'areas_lazer',
                'piscina_fisica': 'areas_lazer',
                'academia_equipamento': 'areas_lazer',
                'salao_festas': 'areas_lazer',
                'churrasqueira': 'areas_lazer',
                'playground': 'areas_lazer',
                'quadra_esportiva': 'areas_lazer',
                'sauna': 'areas_lazer',
                'salao_jogos': 'areas_lazer',
                // ConvivÃªncia
                'convivencia_geral': 'convivencia_regras',
                'barulho_som': 'convivencia_regras',
                'barulho_obra': 'convivencia_regras',
                'barulho_passos': 'convivencia_regras',
                'animais_barulho': 'convivencia_regras',
                'animais_sujeira': 'convivencia_regras',
                'cigarro': 'convivencia_regras',
                'objeto_corredor': 'convivencia_regras',
                'uso_indevido': 'convivencia_regras',
                // Garagem
                'garagem_geral': 'garagem_veiculos',
                'vaga_indevida': 'garagem_veiculos',
                'vaga_ocupacao': 'garagem_veiculos',
                'bicicletario': 'garagem_veiculos',
                'carro_abandonado': 'garagem_veiculos',
                'batida_veiculo': 'garagem_veiculos',
                'portao_garagem_uso': 'garagem_veiculos',
                // Portaria
                'portaria_geral': 'portaria_encomendas',
                'encomenda_sumida': 'portaria_encomendas',
                'delivery_problema': 'portaria_encomendas',
                'correspondencia': 'portaria_encomendas',
                'atendimento_staff': 'portaria_encomendas',
                // Administrativo
                'admin_geral': 'administrativo',
                'segunda_via_boleto': 'administrativo',
                'atualizacao_cadastral': 'administrativo',
                'reserva_espaco': 'administrativo',
                'agendamento_mudanca': 'administrativo',
                'multa_recurso': 'administrativo',
                'assembleia_ata': 'administrativo',
                // Diversos -> Outros
                'sugestao': 'outros',
                'elogio': 'outros',
                'outros': 'outros'
            },
            // Labels detalhados para todas as categorias
            CATEGORY_LABELS: {
                // ElÃ©trica
                'eletrica_geral': 'ElÃ©trica (Geral/Outros)',
                'lampada_queimada': 'ElÃ©trica (LÃ¢mpada Queimada)',
                'disjuntor_caindo': 'ElÃ©trica (Disjuntor Caindo)',
                'tomada_defeito': 'ElÃ©trica (Tomada com Defeito)',
                'sensor_presenca': 'ElÃ©trica (Sensor de PresenÃ§a)',
                'interfone_mudo': 'ElÃ©trica (Interfone Mudo/Falhando)',
                'portao_motor': 'ElÃ©trica (PortÃ£o/Motor)',
                'cerca_eletrica': 'ElÃ©trica (Cerca ElÃ©trica)',
                'para_raios': 'ElÃ©trica (Para-raios/SPDA)',
                'gerador': 'ElÃ©trica (Gerador)',
                'timer_minuteria': 'ElÃ©trica (Timer/Minuteria)',
                'luz_emergencia': 'ElÃ©trica (Luz de EmergÃªncia)',
                // HidrÃ¡ulica
                'hidraulica_geral': 'HidrÃ¡ulica (Geral/Outros)',
                'vazamento_agua': 'HidrÃ¡ulica (Vazamento VisÃ­vel)',
                'infiltracao_parede': 'HidrÃ¡ulica (InfiltraÃ§Ã£o/Mancha)',
                'torneira_pingando': 'HidrÃ¡ulica (Torneira Pingando)',
                'chuveiro_comum': 'HidrÃ¡ulica (Chuveiro Comum)',
                'vaso_entupido': 'HidrÃ¡ulica (Vaso Entupido)',
                'ralo_entupido': 'HidrÃ¡ulica (Ralo Entupido)',
                'pressao_agua': 'HidrÃ¡ulica (PressÃ£o da Ãgua)',
                'bomba_dagua': 'HidrÃ¡ulica (Bomba d\'Ãgua)',
                'falta_agua': 'HidrÃ¡ulica (Falta de Ãgua)',
                'cheiro_gas': 'HidrÃ¡ulica (Cheiro de GÃ¡s)',
                'hidrante': 'HidrÃ¡ulica (Hidrante)',
                // Estrutura
                'estrutura_geral': 'Estrutura (Geral/Outros)',
                'piso_quebrado': 'Estrutura (Piso Quebrado/Solto)',
                'vidro_quebrado': 'Estrutura (Vidro Quebrado)',
                'porta_fechadura': 'Estrutura (Porta/Fechadura)',
                'janela_basculante': 'Estrutura (Janela/Basculante)',
                'telhado_telha': 'Estrutura (Telhado/Telha)',
                'calhas_rufos': 'Estrutura (Calhas/Rufos)',
                'fachada_pastilha': 'Estrutura (Fachada/Pastilha)',
                'pintura_descascando': 'Estrutura (Pintura Descascando)',
                'muro_cerca': 'Estrutura (Muro/Cerca)',
                'acessibilidade': 'Estrutura (Acessibilidade)',
                'escada_corrimao': 'Estrutura (Escada/CorrimÃ£o)',
                // SeguranÃ§a
                'seguranca_geral': 'SeguranÃ§a (Geral/Outros)',
                'camera_cftv': 'SeguranÃ§a (CÃ¢mera CFTV)',
                'alarme_disparado': 'SeguranÃ§a (Alarme Disparado)',
                'controle_acesso': 'SeguranÃ§a (Tag/Biometria/Facial falhando)',
                'chaves_controles': 'SeguranÃ§a (Chaves/Controles)',
                'extintor_vencido': 'SeguranÃ§a (Extintor Vencido)',
                'acesso_estranho': 'SeguranÃ§a (Acesso de Estranho)',
                'veiculo_suspeito': 'SeguranÃ§a (VeÃ­culo Suspeito)',
                'furto_roubo': 'SeguranÃ§a (Furto/Roubo)',
                // Limpeza
                'limpeza_geral': 'Limpeza (Geral/Outros)',
                'coleta_lixo': 'Limpeza (Coleta de Lixo)',
                'mau_cheiro': 'Limpeza (Mau Cheiro)',
                'pragas': 'Limpeza (Pragas/DedetizaÃ§Ã£o)',
                'limpeza_elevador': 'Limpeza (Elevador)',
                'limpeza_escadas': 'Limpeza (Escadas)',
                'limpeza_hall': 'Limpeza (Hall/Corredores)',
                'oleo_garagem': 'Limpeza (Ã“leo na Garagem)',
                'limpeza_vidros': 'Limpeza (Vidros/Espelhos)',
                // Jardinagem
                'jardinagem_geral': 'Jardinagem (Geral/Outros)',
                'grama_alta': 'Jardinagem (Grama Alta)',
                'poda_arvore': 'Jardinagem (Poda de Ãrvore)',
                'plantas_mortas': 'Jardinagem (Plantas Mortas)',
                'irrigacao': 'Jardinagem (IrrigaÃ§Ã£o)',
                'vasos_jardineiras': 'Jardinagem (Vasos/Jardineiras)',
                'folhas_sujeira': 'Jardinagem (Folhas/Sujeira)',
                // Elevadores
                'elevador_geral': 'Elevadores (Geral/Outros)',
                'elevador_parado': 'Elevadores (Elevador Parado)',
                'elevador_barulho': 'Elevadores (Barulho Estranho)',
                'elevador_luz': 'Elevadores (Luz Interna)',
                'elevador_botoes': 'Elevadores (BotÃµes)',
                'elevador_porta': 'Elevadores (Porta)',
                'elevador_ventilador': 'Elevadores (Ventilador)',
                // Ãreas de Lazer
                'lazer_geral': 'Ãreas de Lazer (Geral/Outros)',
                'piscina_agua': 'Ãreas de Lazer (Piscina - Ãgua)',
                'piscina_fisica': 'Ãreas de Lazer (Piscina - Estrutura FÃ­sica)',
                'academia_equipamento': 'Ãreas de Lazer (Academia/Equipamento)',
                'salao_festas': 'Ãreas de Lazer (SalÃ£o de Festas)',
                'churrasqueira': 'Ãreas de Lazer (Churrasqueira)',
                'playground': 'Ãreas de Lazer (Playground)',
                'quadra_esportiva': 'Ãreas de Lazer (Quadra Esportiva)',
                'sauna': 'Ãreas de Lazer (Sauna)',
                'salao_jogos': 'Ãreas de Lazer (SalÃ£o de Jogos)',
                // ConvivÃªncia e Regras
                'convivencia_geral': 'ConvivÃªncia (Geral/Outros)',
                'barulho_som': 'ConvivÃªncia (Barulho de Som)',
                'barulho_obra': 'ConvivÃªncia (Barulho de Obra)',
                'barulho_passos': 'ConvivÃªncia (Barulho de Passos)',
                'animais_barulho': 'ConvivÃªncia (Animais - Barulho)',
                'animais_sujeira': 'ConvivÃªncia (Animais - Sujeira)',
                'cigarro': 'ConvivÃªncia (Cigarro)',
                'objeto_corredor': 'ConvivÃªncia (Objeto em Corredor)',
                'uso_indevido': 'ConvivÃªncia (Uso Indevido de Ãrea)',
                // Garagem e VeÃ­culos
                'garagem_geral': 'Garagem (Geral/Outros)',
                'vaga_indevida': 'Garagem (Vaga Indevida)',
                'vaga_ocupacao': 'Garagem (OcupaÃ§Ã£o de Vaga)',
                'bicicletario': 'Garagem (BicicletÃ¡rio)',
                'carro_abandonado': 'Garagem (Carro Abandonado)',
                'batida_veiculo': 'Garagem (Batida de VeÃ­culo)',
                'portao_garagem_uso': 'Garagem (PortÃ£o - Uso Indevido)',
                // Portaria e Encomendas
                'portaria_geral': 'Portaria (Geral/Outros)',
                'encomenda_sumida': 'Portaria (Encomenda Sumida)',
                'delivery_problema': 'Portaria (Delivery com Problema)',
                'correspondencia': 'Portaria (CorrespondÃªncia)',
                'atendimento_staff': 'Portaria (Atendimento/Staff)',
                // Administrativo
                'admin_geral': 'Administrativo (Geral/Outros)',
                'segunda_via_boleto': 'Administrativo (2Âª Via de Boleto)',
                'atualizacao_cadastral': 'Administrativo (AtualizaÃ§Ã£o Cadastral)',
                'reserva_espaco': 'Administrativo (Reserva de EspaÃ§o)',
                'agendamento_mudanca': 'Administrativo (Agendamento de MudanÃ§a)',
                'multa_recurso': 'Administrativo (Multa/Recurso)',
                'assembleia_ata': 'Administrativo (Assembleia/Ata)',
                // Diversos
                'sugestao': 'Diversos (SugestÃ£o)',
                'elogio': 'Diversos (Elogio)',
                'outros': 'Diversos (Outros)'
            },
            AGING_THRESHOLD_DAYS: 10,
            TOAST_DURATION_MS: 3000,
            WATERMARK_CHECK_INTERVAL_MS: 2000
        };

        // ========================================
        // APLICAÃ‡ÃƒO PRINCIPAL
        // ========================================
        const app = {
            data: {
                tasks: [],
                users: [
                    {name: 'JoÃ£o Silva', email: 'joao@email.com', unit: 'Bl A - 202', role: 'resident'},
                    {name: 'Maria Souza', email: 'maria@email.com', unit: 'Bl B - 501', role: 'resident'}
                ],
                systemLogs: [],
                currentUser: 'manager',
                currentTask: null,
                mobileMenuOpen: false
            },

            activeFilters: ['following'],

            managerFilters: {
                categories: [],
                blocks: [],
                floors: [],
                visibility: [],
                pendingSummary: []
            },

            logState: {
                logs: [],
                page: 1,
                pageSize: 10
            },

            // ========================================
            // FUNÃ‡Ã•ES AUXILIARES
            // ========================================
            getUserInfo(userId) {
                if (userId === 'manager') return {block: null, floor: null, name: 'Gestor', unit: 'GestÃ£o'};
                return CONFIG.USER_BLOCKS[userId] || {block: 'B', floor: '5', name: 'Outro', unit: 'Outro'};
            },

            getMainCategory(detailedCategory) {
                // Retorna a categoria principal baseada na categoria detalhada
                return CONFIG.CATEGORY_MAPPING[detailedCategory] || detailedCategory || 'outros';
            },

            isManager() {
                return this.data.currentUser === 'manager';
            },

            isOwner(task) {
                return task.owner_id === this.data.currentUser;
            },

            canSeeTask(task) {
                if (this.isManager()) {
                    // Para chamados privados de outros usuÃ¡rios, verificar se o filtro estÃ¡ ativo
                    if (task.visibility === 'private' && task.owner_id !== 'manager') {
                        return this.activeFilters.includes('private');
                    }
                    return true;
                }

                const userInfo = this.getUserInfo(this.data.currentUser);
                if (task.visibility === 'public') return true;
                if (task.visibility === 'block' && task.block === userInfo.block) return true;
                if (task.visibility === 'floor' && task.block === userInfo.block && task.floor === userInfo.floor) return true;
                if (task.visibility === 'private' && this.isOwner(task)) return true;

                return false;
            },

            addToHistory(task, action, details) {
                if (!task.history) task.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: this.isManager() ? 'Gestor' : 'VocÃª',
                    action: action,
                    details: details
                };
                task.history.unshift(historyEntry);

                // Adiciona ao log do sistema (histÃ³rico do board)
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: task.title,
                    taskId: task.id
                });
            },

            getTaskAge(task) {
                const createdDate = new Date(task.created_at);
                const diffTime = Math.abs(new Date() - createdDate);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            },

            // Retorna o tÃ­tulo seguro para logs (mediado se existir)
            getSafeTitle(task) {
                return task.public_title || task.title;
            },

            // ========================================
            // INICIALIZAÃ‡ÃƒO
            // ========================================
            init() {
                this.loadData();
                this.updateUserInterface();
                this.updateFilterButtons();
                this.updatePendingBadges();
                this.render();
                this.initWatermark();
                this.initGlobalKeyboardHandler();
            },

            initGlobalKeyboardHandler() {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' || e.key === 'Esc') {
                        if (this.modalStack.length > 0) {
                            e.preventDefault();
                            this.closeTopModal();
                        }
                    }
                });
            },

            loadData() {
                // ForÃ§a regeneraÃ§Ã£o uma Ãºnica vez para atualizar categorias
                const categoryVersion = sessionStorage.getItem('categoryVersion');
                if (categoryVersion !== '2.0') {
                    sessionStorage.clear();
                    sessionStorage.setItem('categoryVersion', '2.0');
                }

                const storedTasks = sessionStorage.getItem('condoTasks');
                const storedUsers = sessionStorage.getItem('condoUsers');
                const storedLogs = sessionStorage.getItem('condoSystemLogs');

                if (storedTasks) this.data.tasks = JSON.parse(storedTasks);
                else this.generateMockData();

                if (storedUsers) this.data.users = JSON.parse(storedUsers);
                if (storedLogs) this.data.systemLogs = JSON.parse(storedLogs);
            },

            saveData() {
                sessionStorage.setItem('condoTasks', JSON.stringify(this.data.tasks));
                sessionStorage.setItem('condoUsers', JSON.stringify(this.data.users));
                sessionStorage.setItem('condoSystemLogs', JSON.stringify(this.data.systemLogs));
                this.render();
            },

            generateMockData() {
                // TÃ­tulos organizados por categoria detalhada
                const taskTemplates = [
                    // ElÃ©trica
                    {title: 'LÃ¢mpada Queimada no Corredor', category: 'lampada_queimada'},
                    {title: 'Disjuntor Caindo Repetidamente', category: 'disjuntor_caindo'},
                    {title: 'Tomada sem Energia na Garagem', category: 'tomada_defeito'},
                    {title: 'Sensor de PresenÃ§a nÃ£o Acende', category: 'sensor_presenca'},
                    {title: 'Interfone com Chiado', category: 'interfone_mudo'},
                    {title: 'Motor do PortÃ£o Travando', category: 'portao_motor'},
                    {title: 'Cerca ElÃ©trica Estalando', category: 'cerca_eletrica'},
                    {title: 'Timer da IluminaÃ§Ã£o Travado', category: 'timer_minuteria'},
                    {title: 'Luz de EmergÃªncia Queimada', category: 'luz_emergencia'},
                    {title: 'Problema ElÃ©trico Geral no Hall', category: 'eletrica_geral'},

                    // HidrÃ¡ulica
                    {title: 'Vazamento VisÃ­vel no Banheiro', category: 'vazamento_agua'},
                    {title: 'InfiltraÃ§Ã£o na Parede', category: 'infiltracao_parede'},
                    {title: 'Torneira Pingando', category: 'torneira_pingando'},
                    {title: 'Vaso SanitÃ¡rio Entupido', category: 'vaso_entupido'},
                    {title: 'Ralo Entupido na Garagem', category: 'ralo_entupido'},
                    {title: 'PressÃ£o da Ãgua Baixa', category: 'pressao_agua'},
                    {title: 'Bomba d\'Ã¡gua com Barulho', category: 'bomba_dagua'},
                    {title: 'Falta de Ãgua no Bloco', category: 'falta_agua'},
                    {title: 'Chuveiro VestiÃ¡rio Quebrado', category: 'chuveiro_comum'},
                    {title: 'Problema HidrÃ¡ulico na Piscina', category: 'hidraulica_geral'},

                    // Estrutura
                    {title: 'Piso Quebrado no Hall', category: 'piso_quebrado'},
                    {title: 'Vidro Trincado na Porta', category: 'vidro_quebrado'},
                    {title: 'MaÃ§aneta Solta', category: 'porta_fechadura'},
                    {title: 'Janela Emperrada', category: 'janela_basculante'},
                    {title: 'Telha Solta no Telhado', category: 'telhado_telha'},
                    {title: 'Calha Entupida', category: 'calhas_rufos'},
                    {title: 'Pastilha Caindo da Fachada', category: 'fachada_pastilha'},
                    {title: 'Pintura Descascando', category: 'pintura_descascando'},
                    {title: 'Grade Danificada', category: 'muro_cerca'},
                    {title: 'CorrimÃ£o Solto na Escada', category: 'escada_corrimao'},

                    // SeguranÃ§a
                    {title: 'CÃ¢mera sem Imagem', category: 'camera_cftv'},
                    {title: 'Alarme Disparando', category: 'alarme_disparado'},
                    {title: 'Biometria Falhando', category: 'controle_acesso'},
                    {title: 'Controle Remoto Perdido', category: 'chaves_controles'},
                    {title: 'Extintor Vencido', category: 'extintor_vencido'},
                    {title: 'PresenÃ§a de Estranhos', category: 'acesso_estranho'},
                    {title: 'VeÃ­culo Suspeito', category: 'veiculo_suspeito'},
                    {title: 'Tentativa de Furto', category: 'furto_roubo'},
                    {title: 'Problema de SeguranÃ§a Geral', category: 'seguranca_geral'},

                    // Limpeza
                    {title: 'Lixo Acumulado no Corredor', category: 'coleta_lixo'},
                    {title: 'Mau Cheiro na Garagem', category: 'mau_cheiro'},
                    {title: 'Baratas no SalÃ£o', category: 'pragas'},
                    {title: 'Elevador Sujo', category: 'limpeza_elevador'},
                    {title: 'Escada Suja', category: 'limpeza_escadas'},
                    {title: 'Hall de Entrada Sujo', category: 'limpeza_hall'},
                    {title: 'Mancha de Ã“leo na Garagem', category: 'oleo_garagem'},
                    {title: 'Vidros Sujos', category: 'limpeza_vidros'},
                    {title: 'Necessidade de Limpeza Geral', category: 'limpeza_geral'},

                    // Jardinagem
                    {title: 'Grama Alta', category: 'grama_alta'},
                    {title: 'Poda de Ãrvore NecessÃ¡ria', category: 'poda_arvore'},
                    {title: 'Plantas Mortas', category: 'plantas_mortas'},
                    {title: 'Sistema de IrrigaÃ§Ã£o Quebrado', category: 'irrigacao'},
                    {title: 'Excesso de Folhas Secas', category: 'folhas_sujeira'},
                    {title: 'Jardinagem Geral', category: 'jardinagem_geral'},

                    // Elevadores
                    {title: 'Elevador Parado', category: 'elevador_parado'},
                    {title: 'Barulho Anormal no Elevador', category: 'elevador_barulho'},
                    {title: 'Luz Interna do Elevador', category: 'elevador_luz'},
                    {title: 'BotÃµes do Elevador Falhando', category: 'elevador_botoes'},
                    {title: 'Porta do Elevador nÃ£o Fecha', category: 'elevador_porta'},
                    {title: 'Problema Geral no Elevador', category: 'elevador_geral'},

                    // Ãreas de Lazer
                    {title: 'Piscina com Ãgua Turva', category: 'piscina_agua'},
                    {title: 'Azulejo Solto na Piscina', category: 'piscina_fisica'},
                    {title: 'Equipamento de Academia Quebrado', category: 'academia_equipamento'},
                    {title: 'SalÃ£o de Festas Sujo', category: 'salao_festas'},
                    {title: 'Churrasqueira com Defeito', category: 'churrasqueira'},
                    {title: 'Brinquedo do Playground Quebrado', category: 'playground'},
                    {title: 'Rede da Quadra Rasgada', category: 'quadra_esportiva'},
                    {title: 'Sauna nÃ£o Esquenta', category: 'sauna'},

                    // ConvivÃªncia
                    {title: 'Barulho Excessivo de Som', category: 'barulho_som'},
                    {title: 'Obra Fora de HorÃ¡rio', category: 'barulho_obra'},
                    {title: 'Barulho de Passos', category: 'barulho_passos'},
                    {title: 'Cachorro Latindo', category: 'animais_barulho'},
                    {title: 'Dejetos de Animais no Corredor', category: 'animais_sujeira'},
                    {title: 'Cigarro em Ãrea Proibida', category: 'cigarro'},
                    {title: 'Bicicleta no Corredor', category: 'objeto_corredor'},
                    {title: 'Uso Indevido da Piscina', category: 'uso_indevido'},

                    // Garagem
                    {title: 'Carro na Vaga Errada', category: 'vaga_indevida'},
                    {title: 'Carro Ocupando 2 Vagas', category: 'vaga_ocupacao'},
                    {title: 'BicicletÃ¡rio Desorganizado', category: 'bicicletario'},
                    {title: 'VeÃ­culo Abandonado', category: 'carro_abandonado'},
                    {title: 'ColisÃ£o entre VeÃ­culos', category: 'batida_veiculo'},

                    // Portaria
                    {title: 'Encomenda nÃ£o Localizada', category: 'encomenda_sumida'},
                    {title: 'Problema com Delivery', category: 'delivery_problema'},
                    {title: 'CorrespondÃªncia Trocada', category: 'correspondencia'},
                    {title: 'Atendimento do Porteiro', category: 'atendimento_staff'},

                    // Administrativo
                    {title: '2Âª Via de Boleto', category: 'segunda_via_boleto'},
                    {title: 'AtualizaÃ§Ã£o de Cadastro', category: 'atualizacao_cadastral'},
                    {title: 'Reserva de SalÃ£o', category: 'reserva_espaco'},
                    {title: 'Agendamento de MudanÃ§a', category: 'agendamento_mudanca'},
                    {title: 'Recurso de Multa', category: 'multa_recurso'},

                    // Diversos
                    {title: 'SugestÃ£o de Melhoria', category: 'sugestao'},
                    {title: 'Elogio ao FuncionÃ¡rio', category: 'elogio'},
                    {title: 'Outros Assuntos', category: 'outros'}
                ];

                const locales = ['Hall', 'Garagem', 'Piscina', 'SalÃ£o de Festas', 'Bloco A', 'Bloco B', 'Entrada'];
                const now = new Date();

                for (let i = 0; i < 100; i++) {
                    const statusList = ['backlog', 'doing', 'stuck', 'done', 'archived'];
                    const status = statusList[Math.floor(Math.random() * statusList.length)];
                    const visList = ['public', 'public', 'public', 'block', 'floor', 'private'];
                    const vis = visList[Math.floor(Math.random() * visList.length)];
                    const owner = Math.random() > 0.8 ? 'resident_A_2' : (Math.random() > 0.5 ? 'resident_B_5' : 'other');

                    // Selecionar template aleatÃ³rio (com categoria jÃ¡ definida)
                    const template = taskTemplates[Math.floor(Math.random() * taskTemplates.length)];
                    const locale = locales[Math.floor(Math.random() * locales.length)];

                    const daysAgo = Math.floor(Math.random() * 20);
                    const creationDate = new Date();
                    creationDate.setDate(now.getDate() - daysAgo);

                    const history = [{
                        date: creationDate.toISOString(),
                        user: owner === 'manager' ? 'GestÃ£o' : 'CondÃ´mino',
                        action: 'Chamado Criado',
                        details: `Status inicial: ${status}`
                    }];

                    if (Math.random() > 0.5) {
                        const moveDate = new Date(creationDate);
                        moveDate.setHours(moveDate.getHours() + 2);
                        history.unshift({
                            date: moveDate.toISOString(),
                            user: 'Gestor',
                            action: 'MudanÃ§a de Status',
                            details: `De BACKLOG para DOING`
                        });
                    }

                    const attachments = [];
                    if (Math.random() > 0.7) {
                        attachments.push({type: 'image', name: 'foto_evidencia.jpg', private: Math.random() > 0.5});
                    }

                    const followers = [];
                    if (vis !== 'private') {
                        if (Math.random() > 0.7) followers.push('resident_A_2');
                        if (Math.random() > 0.7) followers.push('resident_B_5');
                    }

                    this.data.tasks.push({
                        id: i + 1,
                        title: `${template.title} - ${locale}`,
                        description: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Problema recorrente reportado pelos moradores.',
                        public_summary: null,
                        public_title: null,
                        status: status,
                        visibility: vis,
                        priority: `Q${Math.floor(Math.random() * 4) + 1}`,
                        category: template.category,
                        block: Math.random() > 0.5 ? 'A' : 'B',
                        floor: Math.floor(Math.random() * 10).toString(),
                        owner_id: owner,
                        stuck_reason: status === 'stuck' ? 'Aguardando aprovaÃ§Ã£o de orÃ§amento da administradora.' : null,
                        followers: followers,
                        created_at: creationDate.toISOString(),
                        history: history,
                        attachments: attachments
                    });
                }

                this.data.tasks.push({
                    id: 999,
                    title: 'Lixo no corredor Bloco B',
                    description: 'Saco de lixo deixado na porta do 203.',
                    public_summary: 'Relato de item deixado em Ã¡rea comum.',
                    public_title: null,
                    status: 'triage',
                    visibility: 'block',
                    priority: 'Q3',
                    category: 'coleta_lixo',
                    block: 'B', floor: '2',
                    owner_id: 'resident_B_5',
                    followers: [],
                    created_at: new Date().toISOString(),
                    history: [{date: new Date().toISOString(), user: 'CondÃ´mino', action: 'Chamado Aguardando Triagem', details: 'Criado pelo morador.'}],
                    attachments: []
                });

                this.saveData();
            },

            // --- WATERMARK & SECURITY ---
            initWatermark: function () {
                const createWatermark = () => {
                    const existing = document.getElementById('security-watermark');
                    if (existing) existing.remove();

                    const user = this.data.currentUser;
                    const timestamp = new Date().toLocaleTimeString();
                    const text = `${user} â€¢ ${timestamp} â€¢ IP: 192.168.0.1`;

                    const canvas = document.createElement('canvas');
                    canvas.id = 'security-watermark';
                    canvas.className = 'security-layer';
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;

                    const ctx = canvas.getContext('2d');
                    ctx.font = '14px sans-serif';
                    ctx.fillStyle = '#000000';
                    ctx.rotate(-20 * Math.PI / 180);

                    for (let y = -500; y < canvas.height + 500; y += 120) {
                        for (let x = -500; x < canvas.width + 500; x += 300) {
                            ctx.fillText(text, x, y);
                        }
                    }

                    document.body.appendChild(canvas);
                };

                createWatermark();

                setInterval(() => {
                    const watermark = document.getElementById('security-watermark');
                    let violation = false;

                    if (!watermark) {
                        violation = true;
                    } else {
                        const style = window.getComputedStyle(watermark);
                        if (style.display === 'none' || style.visibility === 'hidden' || style.opacity < 0.01 || style.zIndex < 0) {
                            violation = true;
                            watermark.remove();
                        }
                    }

                    if (violation) {
                        console.warn("Security Alert: Watermark tampering detected.");

                        this.data.systemLogs.unshift({
                            date: new Date().toISOString(),
                            user: this.data.currentUser === 'manager' ? 'Gestor' : 'Morador',
                            action: 'VIOLAÃ‡ÃƒO DE SEGURANÃ‡A',
                            details: 'Tentativa de ocultar/remover marca d\'Ã¡gua identificada.',
                            taskTitle: 'Sistema',
                            taskId: null
                        });
                        this.saveData();
                        this.showToast('warning', 'SeguranÃ§a', 'ViolaÃ§Ã£o registrada.');

                        createWatermark();
                    }
                }, 2000);

                window.addEventListener('resize', () => {
                    const w = document.getElementById('security-watermark');
                    if (w) w.remove();
                    createWatermark();
                });
            },

            // --- MOBILE MENU LOGIC ---
            toggleMobileMenu() {
                this.data.mobileMenuOpen = !this.data.mobileMenuOpen;
                const content = document.getElementById('navbarContent');
                const icon = document.getElementById('mobileMenuIcon');

                if (this.data.mobileMenuOpen) {
                    content.classList.remove('hidden');
                    content.classList.add('flex');
                    // ForÃ§ar reflow para ativar a transiÃ§Ã£o
                    void content.offsetHeight;
                    content.classList.remove('opacity-0', 'max-h-0');
                    content.classList.add('opacity-100', 'max-h-[600px]');
                    icon.classList.add('rotate-90');
                } else {
                    content.classList.remove('opacity-100', 'max-h-[600px]');
                    content.classList.add('opacity-0', 'max-h-0');
                    icon.classList.remove('rotate-90');
                    // Esperar a transiÃ§Ã£o terminar antes de ocultar
                    setTimeout(() => {
                        content.classList.add('hidden');
                        content.classList.remove('flex');
                    }, 300);
                }
            },

            // --- FILTER LOGIC ---
            toggleFilter: function (filterType) {
                const idx = this.activeFilters.indexOf(filterType);
                if (idx > -1) {
                    this.activeFilters.splice(idx, 1);
                } else {
                    this.activeFilters.push(filterType);
                }
                this.updateFilterButtons();
                this.render();
            },

            updateFilterButtons: function () {
                const counts = this.calculateFilterCounts();

                ['private', 'following', 'floor', 'block', 'public'].forEach(type => {
                    // BotÃµes do modal
                    const btnModal = document.getElementById(`btn-filter-${type}-modal`);
                    const badgeModal = document.getElementById(`badge-${type}-modal`);

                    if (btnModal) {
                        const isActive = this.activeFilters.includes(type);
                        const conf = CONFIG.FILTER_CONFIGS[type];
                        const baseClass = 'w-full px-4 py-3 text-sm font-bold rounded-lg border transition-all flex items-center justify-between';
                        btnModal.className = `${baseClass} ${isActive ? conf.activeClass : conf.inactiveClass}`;

                        if (badgeModal) {
                            badgeModal.textContent = counts[type] || 0;
                            badgeModal.className = `${conf.badgeColor} text-white text-xs font-bold px-2 py-1 rounded-full`;
                        }
                    }
                });
            },

            calculateFilterCounts: function () {
                const isManager = this.isManager();
                const counts = {private: 0, following: 0, floor: 0, block: 0, public: 0};

                if (isManager) {
                    // Para managers, contar chamados privados de outros usuÃ¡rios
                    this.data.tasks.forEach(t => {
                        if (t.status === 'archived' || t.status === 'triage') return;
                        if (t.visibility === 'private' && t.owner_id !== 'manager') {
                            counts.private++;
                        }
                    });
                } else {
                    // Para usuÃ¡rios nÃ£o-admin
                    const userInfo = this.getUserInfo(this.data.currentUser);
                    const {block: userBlock, floor: userFloor} = userInfo;

                    this.data.tasks.forEach(t => {
                        if (t.status === 'archived' || t.status === 'triage') return;
                        if (!this.canSeeTask(t)) return;

                        // Contar 'Meus Chamados' (chamados abertos pelo prÃ³prio usuÃ¡rio)
                        if (t.owner_id === this.data.currentUser) {
                            counts.private++;
                        }

                        // Contar 'Seguindo' (apenas chamados seguidos que nÃ£o sÃ£o do prÃ³prio usuÃ¡rio)
                        if (t.followers && t.followers.includes(this.data.currentUser) && t.owner_id !== this.data.currentUser) {
                            counts.following++;
                        }

                        // Contar chamados por visibilidade (excluindo os do prÃ³prio usuÃ¡rio)
                        if (t.owner_id !== this.data.currentUser) {
                            if (t.visibility === 'floor' && t.block === userBlock && t.floor === userFloor) {
                                counts.floor++;
                            }
                            if (t.visibility === 'block' && t.block === userBlock) {
                                counts.block++;
                            }
                            if (t.visibility === 'public') {
                                counts.public++;
                            }
                        }
                    });
                }

                return counts;
            },

            openTriageModal: function () {
                const triageList = this.data.tasks.filter(t => t.status === 'triage');
                const tbody = document.getElementById('triageTableBody');

                if (triageList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-stone-400 italic">Nenhum chamado aguardando triagem.</td></tr>';
                } else {
                    tbody.innerHTML = triageList.map(t => {
                        // Mapeia categoria detalhada para categoria principal
                        const detailedCategory = t.category || 'outros';
                        const mainCategory = this.getMainCategory(detailedCategory);
                        const categoryConfig = CONFIG.CATEGORIES[mainCategory] || CONFIG.CATEGORIES['outros'];
                        const categoryBadge = `<span class="inline-flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded border ${categoryConfig.badgeBg} ${categoryConfig.badgeText} ${categoryConfig.badgeBorder}"><i class="${categoryConfig.icon}"></i> ${categoryConfig.label}</span>`;

                        return `
                        <tr class="hover:bg-stone-50 border-b border-stone-50 cursor-pointer" onclick="app.closeModals(); app.openCardModal(${t.id})">
                            <td class="px-6 py-3 text-stone-500">${new Date(t.created_at).toLocaleDateString()}</td>
                            <td class="px-6 py-3 font-medium text-stone-800">${t.title}</td>
                            <td class="px-6 py-3">${categoryBadge}</td>
                            <td class="px-6 py-3"><span class="px-2 py-1 bg-stone-100 rounded text-xs font-bold text-stone-600">${t.priority}</span></td>
                            <td class="px-6 py-3 text-right"><button class="text-brand-accent hover:underline text-xs font-bold uppercase">Analisar</button></td>
                        </tr>
                    `;
                    }).join('');
                }

                app.openModal('triageModal');
            },

            render: function () {
                const cols = {backlog: [], doing: [], stuck: [], done: []};
                const counts = {backlog: 0, doing: 0, stuck: 0, done: 0};
                let triageCount = 0;

                const isManager = this.isManager();
                const userInfo = this.getUserInfo(this.data.currentUser);
                const {block: userBlock, floor: userFloor} = userInfo;

                const filtered = this.data.tasks.filter(t => {
                    if (t.status === 'archived') return false;
                    if (t.status === 'triage') {triageCount++; return false;}

                    if (!this.canSeeTask(t)) return false;

                    // Filtros de preferÃªncia (apenas para moradores)
                    if (!isManager) {
                        const isMyTicket = this.isOwner(t);
                        const showMyTickets = this.activeFilters.includes('private');

                        // Se for meu chamado, sÃ³ mostrar se 'Meus Chamados' estiver ativo
                        if (isMyTicket) {
                            return showMyTickets;
                        }

                        // Para chamados de outros, aplicar filtros ativos (mas nunca mostrar chamados prÃ³prios aqui)
                        let matchesFilter = false;

                        if (this.activeFilters.includes('following') && t.followers && t.followers.includes(this.data.currentUser)) {
                            matchesFilter = true;
                        }
                        if (this.activeFilters.includes('floor') && t.visibility === 'floor') {
                            matchesFilter = true;
                        }
                        if (this.activeFilters.includes('block') && t.visibility === 'block') {
                            matchesFilter = true;
                        }
                        if (this.activeFilters.includes('public') && t.visibility === 'public') {
                            matchesFilter = true;
                        }

                        return matchesFilter;
                    }

                    // Filtros do Gestor
                    if (isManager) {
                        const hasAnyFilter = this.managerFilters.categories.length > 0 ||
                            this.managerFilters.blocks.length > 0 ||
                            this.managerFilters.floors.length > 0 ||
                            this.managerFilters.visibility.length > 0 ||
                            this.managerFilters.pendingSummary.length > 0;

                        // Se nÃ£o hÃ¡ filtros ativos, mostrar tudo
                        if (!hasAnyFilter) return true;

                        let matches = true;

                        // Filtro por categoria
                        if (this.managerFilters.categories.length > 0) {
                            const mainCategory = this.getMainCategory(t.category);
                            matches = matches && this.managerFilters.categories.includes(mainCategory);
                        }

                        // Filtro por bloco
                        if (this.managerFilters.blocks.length > 0) {
                            if (this.managerFilters.blocks.includes('all')) {
                                // "Todos Blocos" estÃ¡ ativo, mostrar todos
                            } else {
                                matches = matches && this.managerFilters.blocks.includes(t.block);
                            }
                        }

                        // Filtro por andar
                        if (this.managerFilters.floors.length > 0) {
                            if (this.managerFilters.floors.includes('all')) {
                                // "Todos Andares" estÃ¡ ativo, mostrar todos
                            } else {
                                matches = matches && this.managerFilters.floors.includes(t.floor);
                            }
                        }

                        // Filtro por visibilidade
                        if (this.managerFilters.visibility.length > 0) {
                            matches = matches && this.managerFilters.visibility.includes(t.visibility);
                        }

                        // Filtro por status de resumo pÃºblico
                        if (this.managerFilters.pendingSummary.length > 0) {
                            const hasSummary = t.public_summary && t.public_summary.trim() !== '';
                            const hasPendingFilter = this.managerFilters.pendingSummary.includes('true');
                            const hasDefinedFilter = this.managerFilters.pendingSummary.includes('false');

                            if (hasPendingFilter && hasDefinedFilter) {
                                // Se ambos estÃ£o selecionados, mostra todos
                                // NÃ£o adiciona nenhuma restriÃ§Ã£o
                            } else if (hasPendingFilter) {
                                // Mostra apenas chamados sem resumo definido (independente da visibilidade)
                                matches = matches && !hasSummary;
                            } else if (hasDefinedFilter) {
                                // Mostra apenas chamados com resumo definido
                                matches = matches && hasSummary;
                            }
                        }

                        return matches;
                    }

                    return true;
                });

                filtered.forEach(t => {
                    if (cols[t.status]) {
                        cols[t.status].push(t);
                        counts[t.status]++;
                    }
                });

                ['backlog', 'doing', 'stuck', 'done'].forEach(status => {
                    const el = document.getElementById(`col-${status}`);
                    document.getElementById(`count-${status}`).innerText = counts[status];
                    el.innerHTML = cols[status].map(t => this.createCardHTML(t)).join('');
                });

                const badge = document.getElementById('triageBadge');
                const badgeMobile = document.getElementById('triageBadgeMobile');
                if (triageCount > 0) {
                    badge.classList.remove('hidden');
                    badge.innerText = triageCount;
                    if (badgeMobile) {
                        badgeMobile.classList.remove('hidden');
                        badgeMobile.innerText = triageCount;
                    }
                } else {
                    badge.classList.add('hidden');
                    if (badgeMobile) badgeMobile.classList.add('hidden');
                }
            },

            createNewTicket: function () {
                const title = document.getElementById('newTitle').value;
                const desc = document.getElementById('newDesc').value;
                const vis = document.getElementById('newVisibility').value;
                const category = document.getElementById('newCategory').value;

                if (!title) {
                    this.showToast('warning', 'AtenÃ§Ã£o', 'TÃ­tulo Ã© obrigatÃ³rio');
                    return;
                }

                if (!category) {
                    this.showToast('warning', 'AtenÃ§Ã£o', 'Por favor, selecione uma categoria');
                    return;
                }

                const isManager = this.isManager();
                const initialStatus = isManager ? 'backlog' : 'triage';
                const initialAction = isManager ? 'CriaÃ§Ã£o Direta' : 'Chamado Aguardando Triagem';

                const creationDate = new Date().toISOString();

                const newTask = {
                    id: Date.now(),
                    title: title,
                    description: desc || 'Sem descriÃ§Ã£o.',
                    public_summary: null,
                    public_title: null,
                    status: initialStatus,
                    visibility: vis,
                    priority: 'Q' + (Math.floor(Math.random() * 4) + 1),
                    category: category,
                    block: this.data.currentUser === 'resident_A_2' ? 'A' : 'B',
                    floor: this.data.currentUser === 'resident_A_2' ? '2' : '5',
                    owner_id: this.data.currentUser,
                    followers: [],
                    created_at: creationDate,
                    history: [{
                        date: creationDate,
                        user: isManager ? 'Gestor' : 'CondÃ´mino',
                        action: initialAction,
                        details: isManager ? 'Criado e aprovado pelo gestor.' : 'Enviado para anÃ¡lise do gestor.'
                    }],
                    attachments: []
                };

                this.data.tasks.unshift(newTask);
                this.saveData();
                this.closeModals();
                this.updatePendingBadges();

                document.getElementById('newTitle').value = '';
                document.getElementById('newDesc').value = '';
                document.getElementById('newCategory').value = 'eletrica_geral';

                const msg = isManager ? 'Chamado criado no quadro.' : 'Chamado enviado para triagem.';
                this.showToast('success', 'Sucesso', msg);
            },

            moveTaskTo: function (newStatus) {
                if (!this.data.currentTask) return;

                const oldStatus = this.data.currentTask.status;
                const userName = this.data.currentUser === 'manager' ? 'Gestor' : 'UsuÃ¡rio';
                let actionText = 'MudanÃ§a de Status';
                let details = `De ${oldStatus.toUpperCase()} para ${newStatus.toUpperCase()}`;

                if (oldStatus === 'triage') {
                    actionText = 'AprovaÃ§Ã£o / Triagem';
                    const triageNote = document.getElementById('triageReasonInput').value.trim();
                    if (triageNote) details += `. Obs: ${triageNote}`;
                }

                if (!this.data.currentTask.history) this.data.currentTask.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: userName,
                    action: actionText,
                    details: details
                };
                this.data.currentTask.history.unshift(historyEntry);

                // Adiciona ao log do sistema (histÃ³rico do board)
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: this.getSafeTitle(this.data.currentTask),
                    taskId: this.data.currentTask.id
                });

                this.data.currentTask.status = newStatus;
                this.data.currentTask.stuck_reason = null;
                this.saveData();
                this.updatePendingBadges();
                this.closeModals();
                this.showToast('success', 'Movimentado!', `Chamado atualizado com sucesso.`);
            },

            archiveCurrentTask: function () {
                const task = this.data.currentTask;
                const isTriage = task.status === 'triage';

                const input = document.getElementById('archiveReasonInput');
                input.classList.remove('hidden');
                input.placeholder = isTriage ? "Motivo da rejeiÃ§Ã£o/arquivamento (ObrigatÃ³rio)..." : "Motivo do arquivamento...";
                input.value = '';

                app.openModal('archiveConfirmModal');
            },

            confirmArchive: function () {
                if (!this.data.currentTask) return;

                const task = this.data.currentTask;
                const isTriage = task.status === 'triage';
                const reason = document.getElementById('archiveReasonInput').value.trim();

                if (isTriage && !reason) {
                    this.showToast('warning', 'AtenÃ§Ã£o', "Por favor, informe o motivo do arquivamento/rejeiÃ§Ã£o.");
                    return;
                }

                const action = isTriage ? 'Rejeitado / Arquivado' : 'Arquivado';
                const details = reason ? `Motivo: ${reason}` : 'Chamado movido para arquivo morto.';

                if (!task.history) task.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: this.data.currentUser === 'manager' ? 'Gestor' : 'Dono',
                    action: action,
                    details: details
                };
                task.history.unshift(historyEntry);

                // Adiciona ao log do sistema (histÃ³rico do board)
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: task.title,
                    taskId: task.id
                });

                task.status = 'archived';
                this.saveData();
                this.closeModals();
                this.showToast('info', 'Arquivado', 'O chamado foi enviado para o Arquivo Morto.');
            },

            modalStack: [],

            closeModals: function () {
                const modals = document.querySelectorAll('[id$="Modal"]');
                modals.forEach(m => {
                    m.classList.add('hidden');
                    m.classList.add('opacity-0');
                    if (m.querySelector('div')) {
                        m.querySelector('div').classList.remove('scale-100');
                        m.querySelector('div').classList.add('scale-95');
                    }
                });
                this.modalStack = [];
            },

            closeTopModal: function () {
                if (this.modalStack.length === 0) return;

                const topModalId = this.modalStack.pop();
                const modal = document.getElementById(topModalId);

                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.add('opacity-0');
                    if (modal.querySelector('div')) {
                        modal.querySelector('div').classList.remove('scale-100');
                        modal.querySelector('div').classList.add('scale-95');
                    }
                }
            },

            showToast: function (type, title, msg) {
                const container = document.getElementById('toast-container');
                const conf = CONFIG.TOAST_CONFIG[type];
                const toast = document.createElement('div');
                toast.className = `transform transition-all duration-300 bg-white border-l-4 rounded shadow-lg overflow-hidden flex flex-col shadow-stone-300 ${conf.border} translate-x-full pointer-events-auto shrink-0`;
                toast.innerHTML = `
                    <div class="p-4 flex items-start gap-3 relative bg-white">
                        <div class="mt-0.5 shrink-0">${conf.icon}</div>
                        <div class="flex-1 pr-4">
                            <h4 class="font-bold text-sm text-stone-800">${title}</h4>
                            <p class="text-xs text-stone-500 mt-1 leading-relaxed">${msg}</p>
                        </div>
                        <button class="absolute top-2 right-2 text-stone-400 hover:text-stone-600 p-1.5 rounded-full hover:bg-stone-50 transition" onclick="this.closest('.pointer-events-auto').remove()">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                    <div class="w-full bg-stone-100 h-1">
                        <div class="h-full w-full ${conf.bar}" style="width: 100%"></div>
                    </div>
                `;
                container.appendChild(toast);
                void toast.offsetWidth;
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
                const progressBar = toast.querySelector('div[style="width: 100%"]');
                progressBar.style.transition = `width ${CONFIG.TOAST_DURATION_MS}ms linear`;
                requestAnimationFrame(() => {progressBar.style.width = '0%';});
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.remove('translate-x-0');
                        toast.classList.add('translate-x-full');
                        toast.classList.add('opacity-0');
                        setTimeout(() => {if (toast.parentElement) toast.remove();}, 300);
                    }
                }, CONFIG.TOAST_DURATION_MS);
            },

            openLogModal: function () {
                this.logState.page = 1;
                this.logState.logs = this.collectLogs();
                this.logState.logs.sort((a, b) => new Date(b.date) - new Date(a.date));
                this.renderLogs();
                app.openModal('logModal');
            },

            downloadLog: function () {
                const logs = this.collectLogs();
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (logs.length === 0) {
                    this.showToast('warning', 'Download', 'NÃ£o hÃ¡ registros para baixar.');
                    return;
                }

                const header = ["Data", "Contexto/Card", "UsuÃ¡rio", "AÃ§Ã£o", "Detalhes"];
                const rows = logs.map(log => {
                    const clean = (text) => text ? `"${text.toString().replace(/"/g, '""')}"` : '""';
                    return [
                        clean(new Date(log.date).toLocaleString('pt-BR')),
                        clean(log.taskTitle || "N/A"),
                        clean(log.user),
                        clean(log.action),
                        clean(log.details)
                    ].join(",");
                });

                const csvContent = "\uFEFF" + [header.join(","), ...rows].join("\n");
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);

                const link = document.createElement("a");
                const filename = `condokanban_logs_${new Date().toISOString().split('T')[0]}.csv`;

                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.showToast('success', 'Download', `Arquivo ${filename} gerado.`);
            },

            toggleArchiveView: function () {
                this.openArchiveListModal();
            },

            openArchiveListModal: function () {
                const archivedTasks = this.data.tasks.filter(t => t.status === 'archived');
                const tbody = document.getElementById('archiveTableBody');

                if (archivedTasks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-stone-400 italic">Nenhum chamado arquivado.</td></tr>';
                } else {
                    tbody.innerHTML = archivedTasks.map(t => {
                        const ownerDisplay = this.isManager()
                            ? (t.owner_id === 'manager' ? 'Gestor' :
                                t.owner_id === 'resident_A_2' ? 'JoÃ£o Silva (Bl A)' :
                                    t.owner_id === 'resident_B_5' ? 'Maria Souza (Bl B)' : 'Outro')
                            : 'CondÃ´mino';

                        return `
                            <tr class="hover:bg-stone-50 border-b border-stone-50 cursor-pointer" onclick="app.closeModals(); app.openCardModal(${t.id})">
                                <td class="px-6 py-3 font-medium text-stone-800">${t.title}</td>
                                <td class="px-6 py-3 text-stone-500">${new Date(t.created_at).toLocaleDateString('pt-BR')}</td>
                                <td class="px-6 py-3 text-stone-600">${ownerDisplay}</td>
                                <td class="px-6 py-3 text-right">
                                    <button class="text-brand-accent hover:underline text-xs font-bold uppercase">Ver Detalhes</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                this.openModal('archiveListModal');
            },

            openNewTicketModal: function () {
                this.openModal('newTicketModal');
            },

            openFilterModal: function () {
                if (this.isManager()) {
                    this.updateManagerFilterButtons();
                    this.openModal('managerFilterModal');
                } else {
                    this.updateFilterButtons();
                    this.openModal('filterModal');
                }
            },

            toggleManagerFilter: function (type, value) {
                let filterArray;
                if (type === 'category') {
                    filterArray = this.managerFilters.categories;
                } else if (type === 'block') {
                    filterArray = this.managerFilters.blocks;
                } else if (type === 'floor') {
                    filterArray = this.managerFilters.floors;
                } else if (type === 'visibility') {
                    filterArray = this.managerFilters.visibility;
                } else if (type === 'pendingSummary') {
                    filterArray = this.managerFilters.pendingSummary;
                }

                if (!filterArray) return;

                const idx = filterArray.indexOf(value);

                if (idx > -1) {
                    filterArray.splice(idx, 1);
                } else {
                    filterArray.push(value);
                }

                this.updateManagerFilterButtons();
                this.render();
            },

            clearManagerFilters: function () {
                this.managerFilters = {
                    categories: [],
                    blocks: [],
                    floors: [],
                    visibility: [],
                    pendingSummary: []
                };
                this.updateManagerFilterButtons();
                this.render();
            },

            updateManagerFilterButtons: function () {
                const activeClass = 'bg-brand-accent text-white border-brand-accent ring-2 ring-brand-accent/30';
                const inactiveClass = 'bg-stone-50 text-stone-700 border-stone-300 hover:bg-stone-100';

                // Atualizar botÃµes de categoria
                ['eletrica', 'hidraulica', 'estrutura', 'seguranca', 'limpeza', 'jardinagem', 'elevadores', 'areas_lazer', 'convivencia_regras', 'garagem_veiculos', 'portaria_encomendas', 'administrativo', 'outros'].forEach(cat => {
                    const btn = document.getElementById(`btn-mgr-cat-${cat}`);
                    if (btn) {
                        const isActive = this.managerFilters.categories.includes(cat);
                        btn.className = `px-3 py-2 text-xs font-bold rounded-lg border transition-all ${isActive ? activeClass : inactiveClass}`;
                    }
                });

                // Atualizar botÃµes de bloco
                ['all', 'A', 'B', 'C'].forEach(block => {
                    const btn = document.getElementById(`btn-mgr-block-${block}`);
                    if (btn) {
                        const isActive = this.managerFilters.blocks.includes(block);
                        btn.className = `px-3 py-2 text-xs font-bold rounded-lg border transition-all ${isActive ? activeClass : inactiveClass}`;
                    }
                });

                // Atualizar botÃµes de andar
                ['all', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'].forEach(floor => {
                    const btn = document.getElementById(`btn-mgr-floor-${floor}`);
                    if (btn) {
                        const isActive = this.managerFilters.floors.includes(floor);
                        btn.className = `px-3 py-2 text-xs font-bold rounded-lg border transition-all ${isActive ? activeClass : inactiveClass}`;
                    }
                });

                // Atualizar botÃµes de visibilidade
                ['public', 'block', 'floor', 'private'].forEach(vis => {
                    const btn = document.getElementById(`btn-mgr-vis-${vis}`);
                    if (btn) {
                        const isActive = this.managerFilters.visibility.includes(vis);
                        btn.className = `px-3 py-2 text-xs font-bold rounded-lg border transition-all ${isActive ? activeClass : inactiveClass}`;
                    }
                });

                // Atualizar botÃµes de status de resumo
                ['true', 'false'].forEach(pending => {
                    const btn = document.getElementById(`btn-mgr-pending-${pending}`);
                    if (btn) {
                        const isActive = this.managerFilters.pendingSummary.includes(pending);
                        btn.className = `px-3 py-2 text-xs font-bold rounded-lg border transition-all ${isActive ? activeClass : inactiveClass}`;
                    }
                });
            },

            openPendingCallsModal: function () {
                this.renderPendingCalls();
                this.openModal('pendingCallsModal');
            },

            renderPendingCalls: function () {
                const container = document.getElementById('pendingCallsTable');
                const pendingTasks = this.data.tasks.filter(t =>
                    t.status === 'triage' && t.owner_id === this.data.currentUser
                );

                if (pendingTasks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-stone-400">
                            <i class="fas fa-check-circle text-5xl mb-4"></i>
                            <p class="text-lg font-semibold">Nenhum chamado pendente</p>
                            <p class="text-sm">Todos os seus chamados foram classificados!</p>
                        </div>
                    `;
                    return;
                }

                const tableHTML = `
                    <table class="w-full">
                        <thead class="bg-stone-50 border-b-2 border-stone-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-stone-600 uppercase">Criado em</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-stone-600 uppercase">TÃ­tulo</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-stone-600 uppercase">Categoria</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-stone-600 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pendingTasks.map(t => {
                    const detailedCategory = t.category || 'outros';
                    const mainCategory = this.getMainCategory(detailedCategory);
                    const categoryConfig = CONFIG.CATEGORIES[mainCategory] || CONFIG.CATEGORIES['outros'];
                    const categoryLabel = CONFIG.CATEGORY_LABELS[detailedCategory] || categoryConfig.label;
                    const categoryBadge = `<span class="inline-flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded border ${categoryConfig.badgeBg} ${categoryConfig.badgeText} ${categoryConfig.badgeBorder}"><i class="${categoryConfig.icon}"></i> ${categoryLabel}</span>`;

                    return `
                                    <tr class="hover:bg-stone-50 border-b border-stone-100">
                                        <td class="px-4 py-3 text-sm text-stone-600">${new Date(t.created_at).toLocaleDateString('pt-BR')}</td>
                                        <td class="px-4 py-3 font-medium text-stone-800">${t.title}</td>
                                        <td class="px-4 py-3">${categoryBadge}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold border border-orange-200">
                                                <i class="fas fa-hourglass-half"></i> Aguardando Triagem
                                            </span>
                                        </td>
                                    </tr>
                                `;
                }).join('')}
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHTML;
            },

            updatePendingBadges: function () {
                if (this.isManager()) return;

                const pendingCount = this.data.tasks.filter(t =>
                    t.status === 'triage' && t.owner_id === this.data.currentUser
                ).length;

                const badgeMobile = document.getElementById('pendingBadgeMobile');
                const badgeDesktop = document.getElementById('pendingBadgeDesktop');

                [badgeMobile, badgeDesktop].forEach(badge => {
                    if (badge) {
                        badge.textContent = pendingCount;
                        badge.classList.toggle('hidden', pendingCount === 0);
                    }
                });
            },

            openUserModal: function () {
                this.openModal('userModal');
                this.renderUsers();
            },

            renderUsers: function () {
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = this.data.users.map((u, index) => `
                    <tr class="border-b border-stone-100">
                        <td class="py-3">${u.name}</td>
                        <td class="py-3 text-stone-500">${u.unit}</td>
                        <td class="py-3 text-stone-500">${u.email}</td>
                        <td class="py-3 text-right">
                            <button onclick="app.deleteUser(${index})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            addUser: function () {
                const name = document.getElementById('uName').value;
                const email = document.getElementById('uEmail').value;
                const unit = document.getElementById('uUnit').value;

                if (name && email && unit) {
                    this.data.users.push({name, email, unit, role: 'resident'});
                    this.data.systemLogs.push({date: new Date().toISOString(), user: 'Gestor', action: 'UsuÃ¡rio Adicionado', details: `Novo: ${name} (${unit})`, taskTitle: 'Sistema Geral', taskId: null});
                    document.getElementById('uName').value = '';
                    document.getElementById('uEmail').value = '';
                    document.getElementById('uUnit').value = '';
                    this.renderUsers();
                    this.saveData();
                    this.showToast('success', 'UsuÃ¡rio', 'Adicionado com sucesso.');
                }
            },

            deleteUser: function (index) {
                if (confirm('Remover usuÃ¡rio?')) {
                    const removedUser = this.data.users[index];
                    this.data.users.splice(index, 1);
                    this.data.systemLogs.push({date: new Date().toISOString(), user: 'Gestor', action: 'UsuÃ¡rio Removido', details: `Removido: ${removedUser.name} (${removedUser.unit})`, taskTitle: 'Sistema Geral', taskId: null});
                    this.renderUsers();
                    this.saveData();
                    this.showToast('warning', 'UsuÃ¡rio', 'Removido do sistema.');
                }
            },

            collectLogs: function () {
                let logs = [];
                const isManager = this.data.currentUser === 'manager';
                const subTitle = document.getElementById('logSubtitle');

                if (isManager) {
                    if (subTitle) subTitle.textContent = "VisÃ£o Global de AdministraÃ§Ã£o (Todos os registros)";
                    this.data.tasks.forEach(task => {
                        if (task.history) {
                            task.history.forEach(log => {
                                logs.push({...log, taskTitle: task.title, taskId: task.id});
                            });
                        }
                    });
                    if (this.data.systemLogs) {
                        logs = logs.concat(this.data.systemLogs);
                    }
                } else {
                    if (subTitle) subTitle.textContent = "Seus Chamados e Chamados Seguidos";
                    this.data.tasks.forEach(task => {
                        const isMine = task.owner_id === this.data.currentUser;
                        const isFollowed = task.followers && task.followers.includes(this.data.currentUser);
                        if (isMine || isFollowed) {
                            if (task.history) {
                                task.history.forEach(log => {
                                    logs.push({...log, taskTitle: task.title, taskId: task.id});
                                });
                            }
                        }
                    });
                }
                return logs;
            },

            renderLogs: function () {
                const {logs, page, pageSize} = this.logState;
                const tbody = document.getElementById('logTableBody');
                const start = (page - 1) * pageSize;
                const end = start + pageSize;
                const paginatedLogs = logs.slice(start, end);

                document.getElementById('logTotalCount').textContent = `${logs.length} Registros`;
                document.getElementById('logPageInfo').textContent = `PÃ¡gina ${page} de ${Math.ceil(logs.length / pageSize) || 1}`;

                document.getElementById('btnPrevLog').disabled = page === 1;
                document.getElementById('btnNextLog').disabled = end >= logs.length;

                if (paginatedLogs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-stone-400 italic">Nenhum registro encontrado.</td></tr>';
                    return;
                }

                tbody.innerHTML = paginatedLogs.map(log => `
                    <tr class="hover:bg-stone-50 border-b border-stone-50">
                        <td class="px-6 py-3 text-stone-500 whitespace-nowrap">${new Date(log.date).toLocaleString('pt-BR')}</td>
                        <td class="px-6 py-3 font-medium text-stone-800 truncate max-w-[200px]" title="${log.taskTitle}">
                            ${log.taskId ? `<a href="#" onclick="app.closeModals(); app.openCardModal(${log.taskId})" class="hover:text-brand-accent hover:underline">${log.taskTitle}</a>` : `<span class="text-stone-500">${log.taskTitle}</span>`}
                        </td>
                        <td class="px-6 py-3 text-stone-600">${log.user}</td>
                        <td class="px-6 py-3"><span class="px-2 py-1 bg-stone-100 rounded text-xs font-bold text-stone-600 uppercase">${log.action}</span></td>
                        <td class="px-6 py-3 text-stone-500 italic truncate max-w-[250px]" title="${log.details}">${log.details}</td>
                    </tr>
                `).join('');
            },

            changeLogPage: function (dir) {
                this.logState.page += dir;
                this.renderLogs();
            },

            createCardHTML: function (task) {
                const isManager = this.isManager();
                const isOwner = this.isOwner(task);
                const isPrivateVis = task.visibility === 'private';

                // MediaÃ§Ã£o de tÃ­tulo - TODOS veem tÃ­tulo pÃºblico quando existe
                let displayTitle;
                let titleClass = "text-sm font-semibold text-brand-text leading-tight mb-1 line-clamp-2";

                if (task.public_title) {
                    // Se hÃ¡ tÃ­tulo pÃºblico, TODOS veem ele (gestores e nÃ£o-gestores)
                    displayTitle = task.public_title;
                } else {
                    // Se nÃ£o hÃ¡ tÃ­tulo pÃºblico, mostrar texto genÃ©rico para todos em itÃ¡lico
                    displayTitle = "TÃ­tulo pÃºblico ainda nÃ£o definido";
                    titleClass = "text-sm font-semibold text-stone-400 italic leading-tight mb-1 line-clamp-2";
                }

                // MediaÃ§Ã£o de descriÃ§Ã£o - TODOS veem descriÃ§Ã£o pÃºblica no board
                let displayDescription;
                if (task.public_summary) {
                    // Se hÃ¡ resumo pÃºblico, TODOS veem ele
                    displayDescription = task.public_summary;
                } else {
                    // Se nÃ£o hÃ¡ resumo pÃºblico, mostrar texto genÃ©rico
                    displayDescription = "<span class='italic text-stone-400'>ConteÃºdo sob anÃ¡lise da administraÃ§Ã£o.</span>";
                }

                let pendingSummaryAlert = '';
                if (isManager && !task.public_title && task.visibility !== 'private') {
                    pendingSummaryAlert = `<span class="text-[10px] leading-none font-bold text-orange-600 bg-orange-100 border border-orange-200 px-1.5 rounded h-6 inline-flex items-center justify-center gap-1" title="Este chamado pÃºblico ainda nÃ£o tem um tÃ­tulo moderado definido"><i class="fas fa-shield-alt"></i> PENDENTE</span>`;
                }

                let followBtn = '';

                // Apenas mostrar botÃ£o de seguir se nÃ£o for manager, nÃ£o for privado E nÃ£o for o dono do chamado
                if (!isManager && !isPrivateVis && task.owner_id !== this.data.currentUser) {
                    const isFollowing = task.followers && task.followers.includes(this.data.currentUser);
                    const iconClass = isFollowing ? 'fas fa-star text-amber-400' : 'far fa-star text-stone-300 hover:text-amber-400';
                    const title = isFollowing ? 'Deixar de Seguir' : 'Seguir Chamado';
                    followBtn = `<button onclick="event.stopPropagation(); app.toggleFollow(${task.id})" class="h-6 w-6 inline-flex items-center justify-center transition-transform active:scale-95" title="${title}"><i class="${iconClass} text-[10px]"></i></button>`;
                }

                let stuckHTML = '';
                if (task.status === 'stuck' && task.stuck_reason) {
                    stuckHTML = `<div class="mt-2 text-[11px] text-red-600 bg-red-50 p-1.5 rounded border border-red-100 italic truncate"><i class="fas fa-exclamation-circle mr-1"></i>${task.stuck_reason}</div>`;
                }

                const diffDays = this.getTaskAge(task);
                let agingHTML = '';
                if (diffDays > CONFIG.AGING_THRESHOLD_DAYS && task.status !== 'done') {
                    agingHTML = `<span class="text-[10px] leading-none text-red-500 font-bold ml-1 h-6 inline-flex items-center justify-center gap-1"><i class="far fa-clock"></i> ${diffDays}d</span>`;
                }

                let attachHTML = '';
                if (task.attachments && task.attachments.length > 0) {
                    attachHTML = `<i class="fas fa-paperclip text-stone-400 text-[10px] h-6 inline-flex items-center justify-center"></i>`;
                }

                const priorityTextColor = CONFIG.PRIORITY_TEXT_COLORS[task.priority] || 'text-stone-400';

                // Badge de categoria com Ã­cone - mapeia categoria detalhada para principal
                const detailedCategory = task.category || 'outros';
                const mainCategory = this.getMainCategory(detailedCategory);
                const categoryConfig = CONFIG.CATEGORIES[mainCategory] || CONFIG.CATEGORIES['outros'];
                const categoryBadge = `<span class="inline-flex items-center justify-center gap-1 text-[10px] font-bold w-6 h-6 rounded border ${categoryConfig.badgeBg} ${categoryConfig.badgeText} ${categoryConfig.badgeBorder}" title="${categoryConfig.label}"><i class="${categoryConfig.icon}"></i></span>`;

                return `
                <div onclick="app.openCardModal(${task.id})" class="kanban-card bg-white p-3 rounded-lg shadow-sm border border-stone-100 border-l-4 ${CONFIG.PRIORITY_COLORS[task.priority]} mb-2 group">
                    
                    <div class="flex justify-between items-center mb-2 w-full h-6">
                        
                        <div class="flex items-center gap-2 h-6">
                            <div class="h-6 inline-flex items-center">
                                <span class="text-[10px] font-bold ${priorityTextColor} leading-none">${task.priority}</span>
                                ${agingHTML}
                            </div>
                            ${categoryBadge}
                            ${pendingSummaryAlert}
                        </div>

                        <div class="flex items-center gap-2 h-6">
                            ${attachHTML}
                            ${CONFIG.VISIBILITY_BADGES[task.visibility]}
                            ${followBtn}
                        </div>

                    </div>

                    <h4 class="${titleClass}">${displayTitle}</h4>
                    <p class="text-xs text-stone-500 line-clamp-2">${displayDescription}</p>
                    ${stuckHTML}
                </div>`;
            },

            toggleFollow: function (taskId) {
                const task = this.data.tasks.find(t => t.id === taskId);
                if (!task) return;
                if (!task.followers) task.followers = [];

                const userId = this.data.currentUser;
                const idx = task.followers.indexOf(userId);
                const isFollowing = idx > -1;

                if (isFollowing) {
                    task.followers.splice(idx, 1);
                    this.showToast('info', 'Deixou de Seguir', 'VocÃª nÃ£o receberÃ¡ mais atualizaÃ§Ãµes deste chamado.');
                    if (!this.isManager()) {
                        this.addToHistory(task, 'Monitoramento', 'Deixou de seguir este chamado.');
                    }
                } else {
                    task.followers.push(userId);
                    this.showToast('success', 'Seguindo', 'Adicionado Ã  sua visualizaÃ§Ã£o personalizada.');
                    if (!this.isManager()) {
                        this.addToHistory(task, 'Monitoramento', 'ComeÃ§ou a seguir este chamado.');
                    }
                }
                this.saveData();
                this.updateFilterButtons();
                this.render();
            },

            switchUser: function (role) {
                this.data.currentUser = role;
                const filterEl = document.getElementById('viewFilter');
                if (filterEl) filterEl.value = 'all';

                // Reset filtros para moradores: 'Seguindo' e 'Meus Chamados' ativos por padrÃ£o
                if (role !== 'manager') {
                    this.activeFilters = ['following', 'private'];
                } else {
                    // Gestor comeÃ§a sem filtros ativos (nÃ£o mostra privados por padrÃ£o)
                    this.activeFilters = [];
                }

                this.updateUserInterface();
                this.updateFilterButtons();
                this.updatePendingBadges();
                this.render();
                this.initWatermark();
                this.showToast('success', 'Perfil Alterado', `Agora simulando: ${role === 'manager' ? 'Gestor' : 'Morador'}`);
            },

            updateUserInterface: function () {
                const isManager = this.data.currentUser === 'manager';

                const elements = {
                    managerMenu: document.getElementById('managerMenu'),
                    mobileMenu: document.getElementById('managerMenuMobile'),
                    fab: document.getElementById('newTicketFab'),
                    filterFab: document.getElementById('filterFab'),
                    filterButtons: document.getElementById('filterButtonsContainer'),
                    viewFilterContainer: document.getElementById('viewFilterContainer'),
                    mainBoard: document.getElementById('mainBoard'),
                    archiveView: document.getElementById('archiveView'),
                    pendingCallsMobile: document.getElementById('pendingCallsMobile'),
                    pendingCallsDesktop: document.getElementById('pendingCallsDesktop')
                };

                const safeToggle = (el, cls, condition) => {
                    if (el) el.classList.toggle(cls, condition);
                };

                safeToggle(elements.managerMenu, 'hidden', !isManager);
                safeToggle(elements.mobileMenu, 'hidden', !isManager);
                safeToggle(elements.fab, 'hidden', isManager);
                // Gestor tambÃ©m usa o FAB de filtros (mas com modal diferente)
                // Morador sempre vÃª o filterFab
                safeToggle(elements.filterFab, 'hidden', false);
                safeToggle(elements.filterButtons, 'hidden', isManager);

                // BotÃ£o de chamados pendentes sÃ³ para moradores
                safeToggle(elements.pendingCallsMobile, 'hidden', isManager);
                safeToggle(elements.pendingCallsDesktop, 'hidden', isManager);

                if (elements.viewFilterContainer) elements.viewFilterContainer.classList.add('hidden');

                if (elements.mainBoard) elements.mainBoard.classList.remove('hidden');
                if (elements.archiveView) elements.archiveView.classList.add('hidden');
            },

            openModal: function (modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    // Adicionar ao stack
                    if (!this.modalStack.includes(modalId)) {
                        this.modalStack.push(modalId);
                    }

                    // Atualizar z-index baseado na posiÃ§Ã£o no stack
                    const baseZIndex = 50;
                    const zIndex = baseZIndex + (this.modalStack.indexOf(modalId) * 10);
                    modal.style.zIndex = zIndex;

                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        if (modal.querySelector('div')) {
                            modal.querySelector('div').classList.remove('scale-100');
                            modal.querySelector('div').classList.add('scale-100');
                        }
                    }, 10);
                    modal.children[0].classList.add('modal-enter-active');

                    // Adicionar event listener para clicar fora (apenas uma vez)
                    if (!modal.dataset.hasClickOutside) {
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                app.closeTopModal();
                            }
                        });
                        modal.dataset.hasClickOutside = 'true';
                    }
                }
            },

            openCardModal: function (id) {
                const task = this.data.tasks.find(t => t.id === id);
                if (!task) return;
                this.data.currentTask = task;

                const isManager = this.isManager();
                const isOwner = task.owner_id === this.data.currentUser;
                let ownerDisplay = '';

                const showOwner = isManager || isOwner;
                const ownerRow = document.getElementById('modalOwnerRow');

                if (showOwner) {
                    ownerRow.classList.remove('hidden');
                    if (task.owner_id === 'other') {
                        ownerDisplay = isManager ? 'Outro Morador (Bloco C - 101)' : 'CondÃ´mino (Bloco C)';
                    } else if (task.owner_id === 'manager') {
                        ownerDisplay = 'GestÃ£o / SÃ­ndico';
                    } else if (isOwner) {
                        ownerDisplay = 'VocÃª';
                    } else {
                        if (isManager) {
                            ownerDisplay = task.owner_id === 'resident_A_2' ? 'JoÃ£o Silva (Bl A - 202)' : 'Maria Souza (Bl B - 501)';
                        } else {
                            ownerDisplay = task.owner_id === 'resident_A_2' ? 'CondÃ´mino (Bloco A)' : 'CondÃ´mino (Bloco B)';
                        }
                    }
                    document.getElementById('modalOwner').innerText = ownerDisplay;
                } else {
                    ownerRow.classList.add('hidden');
                }

                // Controlar exibiÃ§Ã£o de tÃ­tulos
                const originalTitleContainer = document.getElementById('originalTitleContainer');

                if (isManager) {
                    // Gestor vÃª tÃ­tulo original (privado) e tÃ­tulo pÃºblico
                    originalTitleContainer.classList.remove('hidden');
                    document.getElementById('modalOriginalTitle').innerText = task.title;

                    // Exibir tÃ­tulo pÃºblico ou texto genÃ©rico
                    if (task.public_title) {
                        document.getElementById('modalTitle').innerText = task.public_title;
                        document.getElementById('modalTitle').className = "text-xl font-bold text-brand-text leading-tight";
                    } else {
                        document.getElementById('modalTitle').innerText = "TÃ­tulo pÃºblico ainda nÃ£o definido";
                        document.getElementById('modalTitle').className = "text-xl font-bold text-stone-400 italic leading-tight";
                    }
                } else {
                    // NÃ£o-gestores
                    originalTitleContainer.classList.add('hidden');

                    let displayTitle;
                    if (task.public_title) {
                        // Se hÃ¡ tÃ­tulo pÃºblico, mostrar ele
                        displayTitle = task.public_title;
                    } else {
                        // Se nÃ£o hÃ¡ tÃ­tulo pÃºblico, mostrar texto genÃ©rico
                        displayTitle = "TÃ­tulo pÃºblico ainda nÃ£o definido";
                    }
                    document.getElementById('modalTitle').innerText = displayTitle;
                    document.getElementById('modalTitle').className = "text-xl font-bold text-brand-text leading-tight";
                }

                const pStyle = CONFIG.PRIORITY_BADGE_STYLES[task.priority] || CONFIG.PRIORITY_BADGE_STYLES['Q4'];
                const priorityBadge = document.getElementById('modalPriority');
                priorityBadge.innerText = task.priority;
                priorityBadge.className = `h-8 inline-flex items-center justify-center text-xs font-bold px-3 rounded border ${pStyle.bg} ${pStyle.text} ${pStyle.border}`;

                // Badge de categoria no modal - mapeia categoria detalhada para principal
                const detailedCategory = task.category || 'outros';
                const mainCategory = this.getMainCategory(detailedCategory);
                const categoryConfig = CONFIG.CATEGORIES[mainCategory] || CONFIG.CATEGORIES['outros'];
                const categoryBadge = document.getElementById('modalCategory');
                categoryBadge.innerHTML = `<i class="${categoryConfig.icon}"></i> <span>${categoryConfig.label}</span>`;
                categoryBadge.className = `h-8 inline-flex items-center gap-1.5 text-xs font-bold px-3 rounded border ${categoryConfig.badgeBg} ${categoryConfig.badgeText} ${categoryConfig.badgeBorder}`;

                // Dropdown de ediÃ§Ã£o de categoria (apenas para gestor)
                const categoryEditContainer = document.getElementById('modalCategoryEdit');
                const categorySelect = document.getElementById('modalCategorySelect');
                if (isManager) {
                    categoryEditContainer.classList.remove('hidden');
                    categorySelect.value = detailedCategory;
                } else {
                    categoryEditContainer.classList.add('hidden');
                }

                document.getElementById('modalStatus').innerText = task.status;
                document.getElementById('modalDate').innerText = new Date(task.created_at).toLocaleDateString('pt-BR');

                const followersContainer = document.getElementById('modalFollowersContainer');
                if (isManager && task.visibility !== 'private' && task.followers && task.followers.length > 0) {
                    followersContainer.classList.remove('hidden');
                    const followerNames = task.followers.map(fid => {
                        if (fid === 'resident_A_2') return 'JoÃ£o Silva (Bl A)';
                        if (fid === 'resident_B_5') return 'Maria Souza (Bl B)';
                        return 'Outro CondÃ´mino';
                    }).join(', ');
                    document.getElementById('modalFollowersList').innerText = followerNames;
                } else {
                    if (followersContainer) followersContainer.classList.add('hidden');
                }

                const els = {
                    origContainer: document.getElementById('originalDescContainer'),
                    origText: document.getElementById('modalOriginalDesc'),
                    summaryView: document.getElementById('modalPublicSummary'),
                    summaryEditor: document.getElementById('managerSummaryEditor'),
                    summaryInput: document.getElementById('summaryInput'),
                    privacyBadge: document.getElementById('privacyIndicator'),
                    publicLabel: document.getElementById('publicViewLabel')
                };

                els.origContainer.classList.add('hidden');
                els.summaryView.classList.add('hidden');
                els.summaryEditor.classList.add('hidden');
                els.privacyBadge.classList.add('hidden');
                els.publicLabel.classList.add('hidden');

                if (isManager) {
                    els.origContainer.classList.remove('hidden');
                    els.origText.innerText = task.description;

                    els.summaryView.classList.remove('hidden');
                    if (task.public_summary) {
                        els.summaryView.innerText = task.public_summary;
                    } else {
                        els.summaryView.innerHTML = "<span class='text-stone-400 italic'>Nenhum resumo pÃºblico definido ainda.</span>";
                    }

                    els.summaryEditor.classList.remove('hidden');
                    els.summaryInput.value = task.public_summary || '';

                    // BotÃ£o de aprovar descriÃ§Ã£o original
                    const approveBtn = document.getElementById('approveOriginalBtn');
                    if (task.public_summary && task.public_summary.trim() !== '') {
                        approveBtn.classList.add('hidden');
                    } else {
                        approveBtn.classList.remove('hidden');
                    }

                    // Editor de tÃ­tulo pÃºblico
                    const titleEditor = document.getElementById('managerTitleEditor');
                    const titleInput = document.getElementById('publicTitleInput');
                    const approveTitleBtn = document.getElementById('approveOriginalTitleBtn');
                    titleEditor.classList.remove('hidden');
                    titleInput.value = task.public_title || '';

                    // Mostrar botÃ£o de aprovar tÃ­tulo original apenas se ainda nÃ£o houver tÃ­tulo pÃºblico
                    if (task.public_title && task.public_title.trim() !== '') {
                        approveTitleBtn.classList.add('hidden');
                    } else {
                        approveTitleBtn.classList.remove('hidden');
                    }

                    els.privacyBadge.classList.remove('hidden');
                    els.privacyBadge.className = "text-[10px] px-2 py-0.5 rounded border bg-brand-secondary/10 text-brand-secondary border-brand-secondary/30 font-bold uppercase";
                    els.privacyBadge.innerText = "Modo GestÃ£o";

                } else if (isOwner) {
                    // Esconder editor de tÃ­tulo pÃºblico para nÃ£o-gestores
                    const titleEditor = document.getElementById('managerTitleEditor');
                    titleEditor.classList.add('hidden');

                    els.origContainer.classList.remove('hidden');
                    els.origText.innerText = task.description;

                    els.summaryView.classList.remove('hidden');
                    els.publicLabel.classList.remove('hidden');

                    if (task.public_summary) {
                        els.summaryView.innerText = task.public_summary;
                    } else {
                        els.summaryView.innerHTML = "<span class='text-stone-400 italic'>Aguardando anÃ¡lise/resumo da administraÃ§Ã£o.</span>";
                    }

                } else {
                    // Esconder editor de tÃ­tulo pÃºblico para nÃ£o-gestores
                    const titleEditor = document.getElementById('managerTitleEditor');
                    titleEditor.classList.add('hidden');

                    els.summaryView.classList.remove('hidden');
                    if (task.public_summary) {
                        els.summaryView.innerText = task.public_summary;
                    } else {
                        els.summaryView.innerHTML = "<em class='text-stone-400'>A descriÃ§Ã£o detalhada deste chamado Ã© restrita aos envolvidos e Ã  administraÃ§Ã£o.</em>";
                    }
                }

                const visContainer = document.getElementById('modalVisibilityContainer');
                if (isManager) {
                    const visStyles = {
                        'public': 'bg-green-100 text-green-600 border-green-200',
                        'block': 'bg-blue-100 text-blue-600 border-blue-200',
                        'floor': 'bg-purple-100 text-purple-600 border-purple-200',
                        'private': 'bg-stone-200 text-stone-600 border-stone-300'
                    };
                    const activeClass = visStyles[task.visibility] || visStyles['private'];

                    visContainer.innerHTML = `
                        <select onchange="app.changeVisibility(this.value)" class="h-8 text-xs font-bold rounded px-2 shadow-sm focus:ring-2 focus:ring-brand-accent outline-none border ${activeClass}">
                            <option value="public" class="bg-green-100 text-green-600 font-bold" ${task.visibility === 'public' ? 'selected' : ''}>PÃºblico</option>
                            <option value="block" class="bg-blue-100 text-blue-600 font-bold" ${task.visibility === 'block' ? 'selected' : ''}>Bloco</option>
                            <option value="floor" class="bg-purple-100 text-purple-600 font-bold" ${task.visibility === 'floor' ? 'selected' : ''}>Andar</option>
                            <option value="private" class="bg-stone-200 text-stone-600 font-bold" ${task.visibility === 'private' ? 'selected' : ''}>Privado</option>
                        </select>
                    `;
                } else {
                    const badges = {
                        'public': '<span class="h-8 inline-flex items-center text-[10px] uppercase font-bold text-green-600 bg-green-100 px-3 rounded border border-green-200">PÃºblico</span>',
                        'block': '<span class="h-8 inline-flex items-center text-[10px] uppercase font-bold text-blue-600 bg-blue-100 px-3 rounded border border-blue-200">Bloco</span>',
                        'floor': '<span class="h-8 inline-flex items-center text-[10px] uppercase font-bold text-purple-600 bg-purple-100 px-3 rounded border border-purple-200">Andar</span>',
                        'private': '<span class="h-8 inline-flex items-center text-[10px] uppercase font-bold text-stone-500 bg-stone-200 px-3 rounded border border-stone-300">Privado</span>'
                    };
                    visContainer.innerHTML = badges[task.visibility];
                }

                const auditContainer = document.getElementById('auditTrail');
                if (task.history && task.history.length > 0) {
                    auditContainer.innerHTML = task.history.map(h => `
                        <div class="flex gap-4 border-l-2 border-stone-300 pl-4 py-1 relative">
                            <div class="absolute -left-[5px] top-2 w-2 h-2 rounded-full bg-stone-300"></div>
                            <div class="flex-1">
                                <p class="text-xs font-bold text-stone-700">${h.action}</p>
                                <p class="text-xs text-stone-500 italic">${h.details}</p>
                            </div>
                            <div class="text-[10px] text-stone-400 text-right">
                                <p class="font-semibold">${h.user}</p>
                                <p>${new Date(h.date).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    auditContainer.innerHTML = '<p class="italic text-stone-400 text-xs">Sem histÃ³rico registrado.</p>';
                }

                const attachList = document.getElementById('attachmentsList');
                if (task.attachments && task.attachments.length > 0) {
                    attachList.innerHTML = task.attachments.map(att => {
                        const canSeeContent = isManager || isOwner || !att.private;
                        if (canSeeContent) {
                            return `
                                <div class="w-16 h-16 bg-white rounded-lg border border-stone-200 flex flex-col items-center justify-center text-stone-500 shrink-0 cursor-pointer hover:bg-stone-50 hover:border-brand-accent transition shadow-sm group">
                                    <i class="fas fa-file-image text-lg mb-1 group-hover:text-brand-accent"></i>
                                    <span class="text-[8px] truncate w-full text-center px-1 font-medium">${att.name}</span>
                                </div>`;
                        } else {
                            return `
                                <div class="w-16 h-16 bg-red-50 rounded-lg border border-red-100 flex flex-col items-center justify-center text-red-400 shrink-0 shadow-sm" title="Apenas Gestor e Dono podem ver">
                                    <i class="fas fa-lock text-lg mb-1"></i>
                                    <span class="text-[8px] font-bold">Privado</span>
                                </div>`;
                        }
                    }).join('');
                } else {
                    attachList.innerHTML = '<span class="text-xs text-stone-400 italic">Nenhum anexo disponÃ­vel.</span>';
                }

                const stuckContainer = document.getElementById('modalStuckReasonContainer');
                if (task.status === 'stuck' && task.stuck_reason) {
                    stuckContainer.classList.remove('hidden');
                    document.getElementById('modalStuckReason').innerText = task.stuck_reason;
                } else {
                    stuckContainer.classList.add('hidden');
                }

                const actionsContainer = document.getElementById('modalActions');
                const buttonsGrid = document.getElementById('actionButtonsGrid');
                const readOnlyMsg = document.getElementById('modalReadOnlyMsg');
                const triageInput = document.getElementById('triageReasonContainer');
                const archiveBtn = document.getElementById('archiveActionBtn');
                const commentSec = document.getElementById('commentsSection');

                if (isManager) {
                    actionsContainer.classList.remove('hidden');
                    readOnlyMsg.classList.add('hidden');

                    if (task.status === 'triage') {
                        buttonsGrid.innerHTML = `<button onclick="app.moveTaskTo('backlog')" class="col-span-4 p-3 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold text-sm shadow-md transition">Aprovar (Enviar para Backlog)</button>`;
                        triageInput.classList.remove('hidden');
                        archiveBtn.innerText = "Rejeitar / Arquivar";
                        archiveBtn.classList.remove('text-stone-400', 'hover:text-red-500');
                        archiveBtn.classList.add('text-red-600', 'bg-red-50', 'hover:bg-red-100', 'border', 'border-red-200', 'rounded-lg', 'mt-2', 'py-3');
                        commentSec.classList.add('hidden');
                    } else {
                        triageInput.classList.add('hidden');
                        commentSec.classList.remove('hidden');
                        archiveBtn.innerHTML = '<i class="fas fa-archive"></i> Arquivar este chamado';
                        archiveBtn.className = "w-full mt-2 p-2 text-stone-400 hover:text-red-500 text-xs font-semibold flex items-center justify-center gap-2 transition";

                        const statuses = {
                            'backlog': {label: 'Backlog', class: 'border-stone-200 hover:bg-stone-50 text-stone-600'},
                            'doing': {label: 'Fazendo', class: 'border-blue-200 bg-blue-50 text-blue-700 hover:bg-blue-100'},
                            'stuck': {label: 'Enroscado', class: 'border-red-200 bg-red-50 text-red-700 hover:bg-red-100'},
                            'done': {label: 'Feito', class: 'border-green-200 bg-green-50 text-green-700 hover:bg-green-100'}
                        };

                        let html = '';
                        Object.keys(statuses).forEach(key => {
                            const style = statuses[key];
                            if (task.status === key) {
                                html += `<button disabled class="p-2.5 rounded-lg border bg-stone-100 text-stone-400 font-bold text-xs cursor-not-allowed opacity-60">${style.label}</button>`;
                            } else {
                                const action = key === 'stuck' ? 'app.requestStuckReason()' : `app.moveTaskTo('${key}')`;
                                html += `<button onclick="${action}" class="p-2.5 rounded-lg border ${style.class} font-bold text-xs transition">${style.label}</button>`;
                            }
                        });
                        buttonsGrid.innerHTML = html;
                    }
                } else {
                    actionsContainer.classList.add('hidden');
                    triageInput.classList.add('hidden');
                    readOnlyMsg.classList.remove('hidden');
                    commentSec.classList.remove('hidden');
                }

                app.openModal('cardModal');
            },

            // --- FUNÃ‡ÃƒO ATUALIZADA: SAVE PUBLIC SUMMARY ---
            savePublicSummary: function () {
                if (!this.data.currentTask) return;
                const newSummary = document.getElementById('summaryInput').value.trim();

                // Atualiza dados
                this.data.currentTask.public_summary = newSummary;

                // Log com o texto auditado
                if (!this.data.currentTask.history) this.data.currentTask.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: 'Gestor',
                    action: 'ModeraÃ§Ã£o de ConteÃºdo',
                    details: `Resumo PÃºblico atualizado para: "${newSummary}"`
                };
                this.data.currentTask.history.unshift(historyEntry);

                // Adiciona ao log do sistema (histÃ³rico do board)
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: this.getSafeTitle(this.data.currentTask),
                    taskId: this.data.currentTask.id
                });

                this.saveData();
                this.showToast('success', 'Atualizado', 'Resumo pÃºblico definido com sucesso.');

                // Atualiza a visualizaÃ§Ã£o no modal imediatamente
                document.getElementById('modalPublicSummary').innerText = newSummary;
                document.getElementById('modalPublicSummary').classList.remove('hidden');

                // Desabilitar botÃ£o de aprovar descriÃ§Ã£o original apÃ³s salvar
                const approveBtn = document.getElementById('approveOriginalBtn');
                if (approveBtn && newSummary && newSummary.trim() !== '') {
                    approveBtn.classList.add('hidden');
                }

                // Atualizar histÃ³rico em tempo real
                this.updateAuditTrail();

                // ForÃ§a re-render do board para atualizar o badge "PENDENTE" se necessÃ¡rio
                this.render();
            },

            // Nova funÃ§Ã£o: Aprovar descriÃ§Ã£o original como resumo pÃºblico
            approveOriginalDescription: function () {
                if (!this.data.currentTask) return;
                const originalDesc = this.data.currentTask.description;

                // Define a descriÃ§Ã£o original como resumo pÃºblico
                this.data.currentTask.public_summary = originalDesc;

                // Log de aprovaÃ§Ã£o
                if (!this.data.currentTask.history) this.data.currentTask.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: 'Gestor',
                    action: 'ModeraÃ§Ã£o de ConteÃºdo',
                    details: 'DescriÃ§Ã£o original aprovada como Resumo PÃºblico'
                };
                this.data.currentTask.history.unshift(historyEntry);

                // Adiciona ao log do sistema
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: this.data.currentTask.public_title || this.data.currentTask.title,
                    taskId: this.data.currentTask.id
                });

                this.saveData();
                this.showToast('success', 'Aprovado', 'DescriÃ§Ã£o original aprovada como resumo pÃºblico.');

                // Atualiza visualizaÃ§Ãµes
                document.getElementById('summaryInput').value = originalDesc;
                document.getElementById('modalPublicSummary').innerText = originalDesc;
                document.getElementById('modalPublicSummary').classList.remove('hidden');

                // Ocultar botÃ£o de aprovar
                document.getElementById('approveOriginalBtn').classList.add('hidden');

                // Atualizar histÃ³rico em tempo real
                this.updateAuditTrail();

                this.render();
            },

            // Nova funÃ§Ã£o: Aprovar tÃ­tulo original como tÃ­tulo pÃºblico
            approveOriginalTitle: function () {
                if (!this.data.currentTask) return;
                const originalTitle = this.data.currentTask.title;

                // Define o tÃ­tulo original como tÃ­tulo pÃºblico
                this.data.currentTask.public_title = originalTitle;

                // Log de aprovaÃ§Ã£o
                if (!this.data.currentTask.history) this.data.currentTask.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: 'Gestor',
                    action: 'ModeraÃ§Ã£o de ConteÃºdo',
                    details: 'TÃ­tulo original aprovado como TÃ­tulo PÃºblico'
                };
                this.data.currentTask.history.unshift(historyEntry);

                // Adiciona ao log do sistema
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: this.data.currentTask.public_title || this.data.currentTask.title,
                    taskId: this.data.currentTask.id
                });

                this.saveData();
                this.showToast('success', 'Aprovado', 'TÃ­tulo original aprovado como tÃ­tulo pÃºblico.');

                // Atualiza visualizaÃ§Ãµes
                document.getElementById('publicTitleInput').value = originalTitle;
                document.getElementById('modalTitle').innerText = originalTitle;
                document.getElementById('modalTitle').className = "text-xl font-bold text-brand-text leading-tight";

                // Ocultar botÃ£o de aprovar
                document.getElementById('approveOriginalTitleBtn').classList.add('hidden');

                // Atualizar histÃ³rico em tempo real
                this.updateAuditTrail();

                this.render();
            },

            // Nova funÃ§Ã£o: Salvar tÃ­tulo pÃºblico
            savePublicTitle: function () {
                if (!this.data.currentTask) return;
                const newTitle = document.getElementById('publicTitleInput').value.trim();

                // Atualiza dados
                const oldTitle = this.data.currentTask.public_title;
                this.data.currentTask.public_title = newTitle;

                // Log
                if (!this.data.currentTask.history) this.data.currentTask.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: 'Gestor',
                    action: 'ModeraÃ§Ã£o de ConteÃºdo',
                    details: newTitle ? `TÃ­tulo PÃºblico definido: "${newTitle}"` : 'TÃ­tulo PÃºblico removido'
                };
                this.data.currentTask.history.unshift(historyEntry);

                // Adiciona ao log do sistema
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: newTitle || this.data.currentTask.title,
                    taskId: this.data.currentTask.id
                });

                this.saveData();
                this.showToast('success', 'Atualizado', 'TÃ­tulo pÃºblico atualizado com sucesso.');

                // Atualizar visualizaÃ§Ã£o do tÃ­tulo no modal
                if (newTitle) {
                    document.getElementById('modalTitle').innerText = newTitle;
                    document.getElementById('modalTitle').className = "text-xl font-bold text-brand-text leading-tight";
                } else {
                    document.getElementById('modalTitle').innerText = "TÃ­tulo pÃºblico ainda nÃ£o definido";
                    document.getElementById('modalTitle').className = "text-xl font-bold text-stone-400 italic leading-tight";
                }

                // Ocultar botÃ£o de aprovar tÃ­tulo original apÃ³s salvar
                const approveTitleBtn = document.getElementById('approveOriginalTitleBtn');
                if (approveTitleBtn && newTitle && newTitle.trim() !== '') {
                    approveTitleBtn.classList.add('hidden');
                }

                // Atualizar histÃ³rico em tempo real
                this.updateAuditTrail();

                this.render();
            },

            // FunÃ§Ã£o para atualizar o histÃ³rico (audit trail) em tempo real
            updateAuditTrail: function () {
                if (!this.data.currentTask) return;

                const auditContainer = document.getElementById('auditTrail');
                if (this.data.currentTask.history && this.data.currentTask.history.length > 0) {
                    auditContainer.innerHTML = this.data.currentTask.history.map(h => `
                        <div class="flex gap-4 border-l-2 border-stone-300 pl-4 py-1 relative">
                            <div class="absolute -left-[5px] top-2 w-2 h-2 rounded-full bg-stone-300"></div>
                            <div class="flex-1">
                                <p class="text-xs font-bold text-stone-700">${h.action}</p>
                                <p class="text-xs text-stone-500 italic">${h.details}</p>
                            </div>
                            <div class="text-[10px] text-stone-400 text-right">
                                <p class="font-semibold">${h.user}</p>
                                <p>${new Date(h.date).toLocaleString('pt-BR', {day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'})}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    auditContainer.innerHTML = '<p class="italic text-stone-400 text-xs">Sem histÃ³rico registrado.</p>';
                }
            },

            changeVisibility: function (newVis) {
                if (!this.data.currentTask) return;
                const oldVis = this.data.currentTask.visibility;
                if (oldVis === newVis) return;

                const visLabels = {public: 'PÃºblico', block: 'Bloco', floor: 'Andar', private: 'Privado'};

                if (!this.data.currentTask.history) this.data.currentTask.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: 'Gestor',
                    action: 'Visibilidade',
                    details: `Alterada de ${visLabels[oldVis]} para ${visLabels[newVis]}`
                };
                this.data.currentTask.history.unshift(historyEntry);

                // Adiciona ao log do sistema (histÃ³rico do board)
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: this.getSafeTitle(this.data.currentTask),
                    taskId: this.data.currentTask.id
                });

                this.data.currentTask.visibility = newVis;
                this.saveData();
                this.showToast('success', 'Atualizado', 'Visibilidade do chamado alterada.');
                this.openCardModal(this.data.currentTask.id);
            },

            updateTaskCategory: function () {
                if (!this.data.currentTask || !this.isManager()) return;

                const newCategory = document.getElementById('modalCategorySelect').value;
                const oldCategory = this.data.currentTask.category;

                if (oldCategory === newCategory) return;

                // Pega as configuraÃ§Ãµes das categorias principais para exibiÃ§Ã£o
                const oldMainCategory = this.getMainCategory(oldCategory);
                const newMainCategory = this.getMainCategory(newCategory);
                const oldConfig = CONFIG.CATEGORIES[oldMainCategory];
                const newConfig = CONFIG.CATEGORIES[newMainCategory];

                // Obter labels detalhados das categorias
                const oldDetailedLabel = CONFIG.CATEGORY_LABELS[oldCategory] || `${oldConfig.label} (Geral/Outros)`;
                const newDetailedLabel = CONFIG.CATEGORY_LABELS[newCategory] || `${newConfig.label} (Geral/Outros)`;

                // Atualiza a categoria
                this.data.currentTask.category = newCategory;

                // Adiciona ao histÃ³rico com detalhes especÃ­ficos da subcategoria
                if (!this.data.currentTask.history) this.data.currentTask.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: 'Gestor',
                    action: 'ReclassificaÃ§Ã£o',
                    details: `Categoria alterada de "${oldDetailedLabel}" para "${newDetailedLabel}"`
                };
                this.data.currentTask.history.unshift(historyEntry);

                // Adiciona ao log do sistema (histÃ³rico do board)
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: this.getSafeTitle(this.data.currentTask),
                    taskId: this.data.currentTask.id
                });

                // Salva e atualiza a interface
                this.saveData();
                this.showToast('success', 'Reclassificado', `Categoria alterada para ${newConfig.label}`);

                // Atualiza o badge no modal
                const categoryBadge = document.getElementById('modalCategory');
                categoryBadge.innerHTML = `<i class="${newConfig.icon}"></i> <span>${newConfig.label}</span>`;
                categoryBadge.className = `h-8 inline-flex items-center gap-1.5 text-xs font-bold px-3 rounded border ${newConfig.badgeBg} ${newConfig.badgeText} ${newConfig.badgeBorder}`;

                // Atualizar histÃ³rico em tempo real
                this.updateAuditTrail();
            },

            addComment: function () {
                const input = document.getElementById('newCommentInput');
                const text = input.value.trim();
                if (!text || !this.data.currentTask) return;

                const userName = this.data.currentUser === 'manager' ? 'Gestor' : 'VocÃª';

                if (!this.data.currentTask.history) this.data.currentTask.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: userName,
                    action: 'ComentÃ¡rio',
                    details: text
                };
                this.data.currentTask.history.unshift(historyEntry);

                // Adiciona ao log do sistema (histÃ³rico do board)
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: this.getSafeTitle(this.data.currentTask),
                    taskId: this.data.currentTask.id
                });

                this.saveData();
                input.value = '';

                // Atualizar histÃ³rico em tempo real ao invÃ©s de reabrir o modal
                this.updateAuditTrail();
            },

            requestStuckReason: function () {
                this.openModal('stuckModal');
            },

            confirmStuck: function () {
                const reason = document.getElementById('stuckReasonInput').value;
                if (!reason.trim()) {
                    this.showToast('warning', 'AtenÃ§Ã£o', 'Por favor, informe o motivo.');
                    return;
                }
                if (this.data.currentTask) {
                    if (!this.data.currentTask.history) this.data.currentTask.history = [];
                    const historyEntry = {
                        date: new Date().toISOString(),
                        user: 'Gestor',
                        action: 'Marcado como Enroscado',
                        details: reason
                    };
                    this.data.currentTask.history.unshift(historyEntry);

                    // Adiciona ao log do sistema (histÃ³rico do board)
                    if (!this.data.systemLogs) this.data.systemLogs = [];
                    this.data.systemLogs.push({
                        date: historyEntry.date,
                        user: historyEntry.user,
                        action: historyEntry.action,
                        details: historyEntry.details,
                        taskTitle: this.getSafeTitle(this.data.currentTask),
                        taskId: this.data.currentTask.id
                    });

                    this.data.currentTask.status = 'stuck';
                    this.data.currentTask.stuck_reason = reason;
                    this.saveData();
                    document.getElementById('stuckReasonInput').value = '';
                    this.closeModals();
                    this.showToast('warning', 'Enroscado', 'Motivo registrado com sucesso.');
                }
            },

            archiveCurrentTask: function () {
                const task = this.data.currentTask;
                const isTriage = task.status === 'triage';

                const input = document.getElementById('archiveReasonInput');
                input.classList.remove('hidden');
                input.placeholder = isTriage ? "Motivo da rejeiÃ§Ã£o/arquivamento (ObrigatÃ³rio)..." : "Motivo do arquivamento...";
                input.value = '';

                app.openModal('archiveConfirmModal');
            },

            confirmArchive: function () {
                if (!this.data.currentTask) return;

                const task = this.data.currentTask;
                const isTriage = task.status === 'triage';
                const reason = document.getElementById('archiveReasonInput').value.trim();

                if (isTriage && !reason) {
                    this.showToast('warning', 'AtenÃ§Ã£o', "Por favor, informe o motivo do arquivamento/rejeiÃ§Ã£o.");
                    return;
                }

                const action = isTriage ? 'Rejeitado / Arquivado' : 'Arquivado';
                const details = reason ? `Motivo: ${reason}` : 'Chamado movido para arquivo morto.';

                if (!task.history) task.history = [];
                const historyEntry = {
                    date: new Date().toISOString(),
                    user: this.data.currentUser === 'manager' ? 'Gestor' : 'Dono',
                    action: action,
                    details: details
                };
                task.history.unshift(historyEntry);

                // Adiciona ao log do sistema (histÃ³rico do board)
                if (!this.data.systemLogs) this.data.systemLogs = [];
                this.data.systemLogs.push({
                    date: historyEntry.date,
                    user: historyEntry.user,
                    action: historyEntry.action,
                    details: historyEntry.details,
                    taskTitle: task.title,
                    taskId: task.id
                });

                task.status = 'archived';
                this.saveData();
                this.closeModals();
                this.showToast('info', 'Arquivado', 'O chamado foi enviado para o Arquivo Morto.');
            },

            showToast: function (type, title, msg) {
                const container = document.getElementById('toast-container');
                const config = {
                    success: {border: 'border-l-green-500', icon: '<i class="fas fa-check-circle text-green-500 text-xl"></i>', bar: 'bg-green-500'},
                    warning: {border: 'border-l-amber-500', icon: '<i class="fas fa-exclamation-triangle text-amber-500 text-xl"></i>', bar: 'bg-amber-500'},
                    info: {border: 'border-l-blue-500', icon: '<i class="fas fa-info-circle text-blue-500 text-xl"></i>', bar: 'bg-blue-500'}
                };
                const conf = config[type];
                const toast = document.createElement('div');
                toast.className = `transform transition-all duration-300 bg-white border-l-4 rounded shadow-lg overflow-hidden flex flex-col shadow-stone-300 ${conf.border} translate-x-full pointer-events-auto shrink-0`;
                toast.innerHTML = `
                    <div class="p-4 flex items-start gap-3 relative bg-white">
                        <div class="mt-0.5 shrink-0">${conf.icon}</div>
                        <div class="flex-1 pr-4">
                            <h4 class="font-bold text-sm text-stone-800">${title}</h4>
                            <p class="text-xs text-stone-500 mt-1 leading-relaxed">${msg}</p>
                        </div>
                        <button class="absolute top-2 right-2 text-stone-400 hover:text-stone-600 p-1.5 rounded-full hover:bg-stone-50 transition" onclick="this.closest('.pointer-events-auto').remove()">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                    <div class="w-full bg-stone-100 h-1">
                        <div class="h-full w-full ${conf.bar}" style="width: 100%"></div>
                    </div>
                `;
                container.appendChild(toast);
                void toast.offsetWidth;
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
                const progressBar = toast.querySelector('div[style="width: 100%"]');
                progressBar.style.transition = `width ${CONFIG.TOAST_DURATION_MS}ms linear`;
                requestAnimationFrame(() => {progressBar.style.width = '0%';});
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.classList.remove('translate-x-0');
                        toast.classList.add('translate-x-full');
                        toast.classList.add('opacity-0');
                        setTimeout(() => {if (toast.parentElement) toast.remove();}, 300);
                    }
                }, CONFIG.TOAST_DURATION_MS);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>

</html>